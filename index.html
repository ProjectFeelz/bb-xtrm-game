<script>
    // --- MASSIVE DATA DECKS (90+ UNIQUE TASKS) ---
    const SET_LIMIT = 10;
    const paceDecks = [30, 45, 60, 90, 120];
    
    const cardDecks = {
        production: [
            'Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements', 'Mute lead instrument', 'Apply 1/8th delay', 
            'Reverse a vocal tail', 'Add saturation to the kick', 'Sidechain bass to kick', 'Pigeonhole the mid-range', 'Boost 3k on the lead',
            'Automate a low-pass filter', 'Add a chorus effect to pads', 'Mono the low end', 'Pan percussion 30% Left', 'Distort the master bus',
            'Layer white noise on snare', 'Shorten the kick decay', 'Add room reverb to drums', 'Parallel compress the vocals', 'Check for phase issues',
            'Bitcrush the melody', 'Add a subtle slap delay', 'Width-expand the high hats', 'Cut 500Hz on the muddy tracks', 'Limit the drum bus',
            'Add a sub-bass layer', 'Create a transition riser', 'Automate volume on the bridge', 'Frequency shift the percussion', 'Add a flanger to the guitar'
        ],
        songwriting: [
            'Rhyme with Stone', 'No I, Me, or My', '3 consecutive questions', 'Start with previous word', 'Include a color name',
            'Mention a specific city', 'Use a metaphor about weather', 'Write a 4-bar internal rhyme', 'Reference a 90s movie', 'Use a word with 4 syllables',
            'Start every line with "The"', 'Write a double-time verse', 'Avoid using the letter "S"', 'Describe a smell', 'Use a nautical term',
            'Reference a celestial body', 'Write a line in another language', 'Whisper the next two lines', 'End the line with a shout', 'Use an animal analogy',
            'Mention a vintage car', 'Write about a missed phone call', 'Use a mathematical term', 'Describe a glitch', 'Write a line about gravity',
            'Use a word that sounds like its meaning', 'Reference a famous painter', 'Write about a locked door', 'Use a synonym for "Fast"', 'Write a line about silence'
        ],
        beats: [
            'Replace snare with Clap', 'Nudge hi-hats late', 'Pitch kick up 3 semitones', '1-bar drum break', 'Half-time the hats',
            'Double the tempo for 2 bars', 'Add a triplet grid', 'Use a non-drum sound as a snare', 'Velocity edit the velocities', 'Swing the quantize to 60%',
            'Mute the kick for 4 bars', 'Add a crash every 2nd bar', 'Use a rimshot on the 4', 'Layer a foley sound', 'Pitch down the hats',
            'Create a polyrhythmic loop', 'Add a ghost note snare', 'Glitch the last beat of the bar', 'Use a cowbell ironically', 'Filter the master drum bus',
            'Stutter the vocal sample', 'Reverse the crash cymbal', 'Add a shaker loop', 'Syncopate the bassline', 'Use a 808 with a long tail',
            'Add a tambourine on the off-beat', 'Randomize hat panning', 'Create a build-up fill', 'Use a woodblock sound', 'Add a heavy swing to the percussion'
        ]
    };

    // --- STATE ---
    let clout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', currentType = '', tasksCompleted = 0;
    let combo = 0, multiplier = 1.0, currentCallsign = "";
    let lastCard = ""; // Prevention for duplicate cards
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if (name.length < 2) return alert("IDENTIFICATION REQUIRED");
        currentCallsign = name;
        localStorage.setItem('bb_artist_name', name);
        showScreen('screen-rules');
    }

    function startGame(mode) {
        selectedMode = mode;
        tasksCompleted = 0;
        clout = 0;
        combo = 0;
        multiplier = 1.0;
        document.getElementById('user-tag').innerText = `MUSICIAN: ${currentCallsign}`;
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if (tasksCompleted >= SET_LIMIT) { endSession(); return; }
        
        // CRITICAL FIX: Always clear the previous interval before starting a new one
        if (timerInterval) clearInterval(timerInterval);
        
        isPaused = false;
        document.getElementById('pause-btn').innerText = "PAUSE";
        
        const seconds = paceDecks[Math.floor(Math.random() * paceDecks.length)];
        
        currentType = selectedMode === 'xtrm' ? ['production', 'songwriting', 'beats'][Math.floor(Math.random() * 3)] : selectedMode;
        const deck = cardDecks[currentType];
        
        // CRITICAL FIX: Ensure the new card is different from the last card
        let newCard = deck[Math.floor(Math.random() * deck.length)];
        while (newCard === lastCard) {
            newCard = deck[Math.floor(Math.random() * deck.length)];
        }
        lastCard = newCard;

        document.getElementById('card-body').innerText = newCard;
        document.getElementById('card-body').style.color = { production: 'var(--cyan)', songwriting: 'var(--magenta)', beats: 'var(--green)' }[currentType];
        
        updateSessionUI();
        startTimer(seconds);
    }

    function startTimer(seconds) {
        timeLeft = seconds;
        updateUI();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeLeft--; 
                updateUI();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    breakCombo();
                }
            }
        }, 1000);
    }

    function updateUI() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        const el = document.getElementById('timer');
        el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        el.style.color = timeLeft < 10 ? 'var(--red)' : 'var(--yellow)';
        document.getElementById('clout-display').innerText = `CLOUT: ${clout}`;
        document.getElementById('combo-container').style.display = combo >= 3 ? 'block' : 'none';
        document.getElementById('combo-value').innerText = `x${multiplier.toFixed(1)}`;
    }

    function updateSessionUI() {
        document.getElementById('task-counter').innerText = `SET: ${tasksCompleted + 1}/${SET_LIMIT}`;
        document.getElementById('progress-fill').style.width = `${(tasksCompleted / SET_LIMIT) * 100}%`;
    }

    function completeTask() {
        tasksCompleted++;
        combo++;
        multiplier = 1.0 + (Math.floor(combo / 3) * 0.5); 
        clout += Math.floor(10 * multiplier);
        drawTask();
    }

    async function endSession() {
        if (timerInterval) clearInterval(timerInterval);
        showScreen('screen-results');
        document.getElementById('result-artist').innerText = `ARTIST: ${currentCallsign}`;
        document.getElementById('result-clout').innerText = clout;
        document.getElementById('result-footer').innerText = "SYNCING TO GLOBAL RIG...";
        
        try {
            const res = await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: clout })
            });
            if (!res.ok) throw new Error("Sync Failed");
            document.getElementById('result-footer').innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { 
            document.getElementById('result-footer').innerText = "LOCAL SAVE ONLY. CHECK HUB CONNECTION."; 
        }
    }

    async function showLeaderboard() {
        const body = document.getElementById('leaderboard-body');
        body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">ACCESSING SATELLITE...</td></tr>';
        showScreen('screen-board');
        try {
            const res = await fetch(`${API_PATH}/get-scores`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            body.innerHTML = data.map((d, i) => `
                <tr>
                    <td style="padding:10px 0; border-bottom:1px solid #222;">
                        <span style="color:var(--yellow)">#${i+1}</span> ${d.username}
                    </td>
                    <td style="text-align:right; color:var(--cyan)">${d.clout}</td>
                </tr>`).join('');
        } catch (e) { 
            body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:var(--red);">CONNECTION ERROR: RIG OFFLINE</td></tr>'; 
        }
    }

    function skipCard() { if(clout >= 10) { clout -= 10; combo = 0; multiplier = 1.0; drawTask(); } }
    function rerollTimer() { if(clout >= 5) { clout -= 5; drawTask(); } }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { if(confirm("Eject?")) { clearInterval(timerInterval); showScreen('screen-modes'); } }
    function resetRig() { if(confirm("Wipe data?")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        const saved = localStorage.getItem('bb_artist_name');
        if (saved) {
            currentCallsign = saved;
            document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
            showScreen('screen-modes');
        } else {
            showScreen('screen-auth');
        }
    };
</script>
