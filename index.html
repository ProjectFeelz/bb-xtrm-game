<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO</title>
    <style>
        :root {
            --bg: #0a0b0e; --panel: #161a1f; --border: #2a2f36;
            --cyan: #00f2ff; --magenta: #ff00ff; --yellow: #f1c40f;
            --green: #2ecc71; --red: #ff4757;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', monospace; }
        body {
            background-color: var(--bg); color: #e0e0e0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: radial-gradient(circle at center, #1a1d23 0%, #0a0b0e 100%);
        }
        #console {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background: var(--panel); border: 2px solid var(--border);
            border-radius: 20px; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; inset: 0; padding: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: var(--panel); z-index: 10;
        }
        .active-screen { display: flex !important; }
        
        .logo-small { font-size: 2rem; font-weight: 900; color: var(--cyan); margin-bottom: 20px; font-style: italic; }
        h2 { font-size: 0.7rem; letter-spacing: 3px; color: #666; text-transform: uppercase; margin-bottom: 15px; text-align: center; }
        
        #rank-panel {
            width: 100%; background: #0a0b0e; border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 20px; padding: 20px; text-align: center;
        }

        #career-stats { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .badge-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 5px; }
        .mini-badge { width: 12px; height: 12px; background: var(--yellow); border-radius: 50%; box-shadow: 0 0 5px var(--yellow); }

        #cheat-error { color: var(--red); font-weight: bold; font-size: 0.75rem; letter-spacing: 1px; opacity: 0; transition: 0.2s; height: 15px; margin-bottom: 5px; text-transform: uppercase; }

        input {
            width: 100%; padding: 16px; background: #0a0b0e; border: 1px solid var(--border);
            color: var(--cyan); border-radius: 8px; outline: none; font-size: 1.1rem; text-align: center;
        }
        .btn {
            width: 100%; padding: 18px; border: 1px solid var(--border); border-radius: 12px;
            background: rgba(255,255,255,0.03); color: white; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--cyan); color: black; border: none; }
        .btn-locked { background: #1a1d23 !important; color: #444 !important; border: 1px solid #222 !important; cursor: not-allowed; opacity: 0.5; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); font-size: 0.8rem; padding: 12px; }

        #combo-alert { color: var(--magenta); font-weight: 900; font-size: 1.2rem; margin-top: -10px; margin-bottom: 10px; opacity: 0; transition: 0.3s; z-index: 20; height: 20px; text-align: center; }

        .game-hud { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; font-size: 0.8rem; color: #888; }
        .hud-val { color: var(--cyan); font-weight: bold; }
        
        #timer { font-size: 6rem; color: var(--yellow); font-family: monospace; line-height: 1; margin: 0; }
        .timer-low { color: var(--red) !important; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #card { width: 100%; flex: 1; border: 2px solid var(--border); background: #121519; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 25px; text-align: center; margin: 15px 0; font-size: 1.4rem; font-weight: 600; }
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        
        #perfect-badge { 
            display: none; color: var(--yellow); border: 2px solid var(--yellow);
            padding: 10px 20px; border-radius: 50px; font-size: 0.8rem; font-weight: 900;
            margin-top: 15px; animation: glow 1.5s infinite alternate;
        }
        @keyframes glow { from { box-shadow: 0 0 5px var(--yellow); } to { box-shadow: 0 0 20px var(--yellow); } }

        .cooldown-text { font-size: 0.6rem; display: block; margin-top: 4px; opacity: 0.7; font-weight: normal; }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <h2>Registry</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" style="margin-top:20px" onclick="validateAuth()">LOGIN</button>
    </div>

    <div id="screen-manual" class="screen">
        <div class="logo-small">STUDIO OPS</div>
        <div style="text-align: left; font-size: 0.75rem; line-height: 1.5; background: #0a0b0e; padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
            <b style="color:var(--red)">• HIGH STAKES:</b> You have exactly 30s to complete each task. If the timer hits zero, the session ends. <br><br>
            <b style="color:var(--cyan)">• 10s SECURITY LOCK:</b> The 'COMPLETE' button is hard-locked for the first 10s of every card. Focus on the craft during this time.<br><br>
            <b style="color:var(--green)">• SPEED DEMON:</b> Submit your task with more than 15s left on the clock to earn +5 bonus Clout.<br><br>
            <b style="color:var(--magenta)">• XP COMBO:</b> Chain 3 tasks without a RERUN or failure to trigger +25 XP Overdrive.<br><br>
            <b style="color:var(--yellow)">• PERFECT SET:</b> Complete all 10 tasks with 0 RERUNS and 5+ SPEED bonuses to earn a Career Trophy and +100 Clout.
        </div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="showScreen('screen-modes')">INITIALIZE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <h2 id="welcome-msg">WELCOME, ARTIST</h2>
        <div id="rank-panel">
            <div style="color: #666; font-size: 0.6rem; letter-spacing: 2px; margin-bottom: 5px;">CURRENT STATUS</div>
            <div id="global-rank-display" style="font-size: 2.2rem; color: var(--cyan); font-weight: 900;">RANKING...</div>
            <div id="last-score" style="color: var(--yellow); font-size: 0.8rem; margin-top: 5px;">0 LIFETIME CLOUT</div>
            <div id="career-stats">
                <div style="color: #444; font-size: 0.55rem; letter-spacing: 1px;">PERFECT SET HISTORY</div>
                <div id="badge-container" class="badge-row"></div>
            </div>
        </div>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('production')">ENGINEER</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('beats')">BEATS</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('songwriting')">WRITER</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;">
            <button class="btn btn-secondary" onclick="showScreen('screen-manual')">MANUAL</button>
            <button class="btn btn-secondary" onclick="resetAll()">RESET</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-hud">
            <span>TASK: <span id="task-count" class="hud-val">1/10</span></span>
            <span>SESSION: <span id="clout-val" class="hud-val">0</span></span>
        </div>
        <div id="cheat-error">!! SECURITY TRIGGERED: COMPLETE TOO EARLY !!</div>
        <div id="timer">00:30</div>
        <div id="combo-alert">XP OVERDRIVE +25</div>
        <div id="card"><div id="card-body">Awaiting sync...</div></div>
        <div id="game-controls">
            <button id="complete-btn" class="btn btn-primary" style="grid-column: span 2" onclick="attemptComplete()">
                COMPLETE
                <span id="cooldown-timer" class="cooldown-text">LOCKED</span>
            </button>
            <button class="btn btn-secondary" onclick="rerollTask()">RERUN</button>
            <button id="pause-btn" class="btn btn-secondary" onclick="togglePause()">PAUSE</button>
            <button class="btn btn-secondary" style="grid-column: span 2; color: var(--red); border-color: #400;" onclick="exitGame()">EJECT</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 id="result-header">SET COMPLETE</h2>
        <div id="result-clout" style="font-size: 4rem; color: var(--yellow)">0</div>
        <div id="perfect-badge">PERFECT SET // GOLD STATUS</div>
        <p id="result-footer" style="margin-top: 20px;">BANKING CLOUT...</p>
        <button class="btn btn-primary" style="margin-top: 20px" onclick="showScreen('screen-modes')">CONTINUE</button>
    </div>
</div>

<script>
    const SET_LIMIT = 10;
    const TASK_TIME = 30; 
    const cardDecks = {
        production: ['Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements','Mute lead instrument','Apply 1/8th delay','Saturate the Bass','Pan hats 30% Right', 'Double vocals', 'Reverse reverb tail', 'Bitcrush melody','Add 20% swing to midi', 'Sidechain pad to kick', 'Boost 3k on vocals','Automate a low-pass sweep', 'Add a foley texture', 'Clip the master peak','Stereo widen the chorus', 'Mono the sub-bass', 'Add a 1-bar silent gap','Shift a melody up 1 octave', 'Apply a chorus effect to bass', 'Gating on the pads','Distort the parallel bus', 'Ping-pong delay on hats', 'Shorten all kick decays'],
        songwriting: ['Rhyme with Stone', 'No I, Me, or My', '3 questions in a row','Start with previous word', 'Weather metaphor', 'Specific color mentioned','4-line mini story', 'Alliterate next line', 'End line with a verb', 'Write about a machine','Describe a smell', 'Use a word with 4+ syllables', 'Reference a 90s movie','Write a 2-line whisper part', 'Change the perspective to "Them"', 'A line about a clock','Rhyme scheme AABB', 'Internal rhyme only', 'Reference a city name','No words ending in "ing"', 'Start a line with "Never"', 'Add a technical term'],
        beats: ['Replace snare with Clap', 'Nudge hats 5ms late', 'Pitch kick up 2 semitones','1-bar drum break', 'Add shaker loop', 'Reverse the crash','Half-time the hi-hats', 'Velocity humanize kicks', 'Woodblock on the 4', 'Triple hi-hat speed','Delete every 4th kick', 'Add a rimshot on the "and"', 'Ghost note snares','Flanger on the drum bus', 'Pitch down the hats', 'Replace kick with a tom','Add a tambourine on 2 and 4', 'Randomize hat velocities', 'Add a cowbell hit','Filter the drums for 2 bars', 'Roll the snare at the end']
    };

    let sessionClout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', tasksCompleted = 0, currentCallsign = "";
    let comboCount = 0, rerunUsedInSession = false, cleanStreakCount = 0, cooldownLeft = 0, speedDemonCount = 0;
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
        if(id === 'screen-modes') { updateRankDisplay(); renderBadges(); }
    }

    function renderBadges() {
        const count = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
        const container = document.getElementById('badge-container');
        container.innerHTML = '';
        for(let i=0; i<count; i++) {
            const b = document.createElement('div');
            b.className = 'mini-badge';
            container.appendChild(b);
        }
    }

    async function updateRankDisplay() {
        const savedClout = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        document.getElementById('last-score').innerText = `${savedClout} LIFETIME CLOUT`;
        try {
            const res = await fetch(`${API_PATH}/get-scores?t=${Date.now()}`);
            const data = await res.json();
            const sorted = data.sort((a,b) => b.clout - a.clout);
            const rank = sorted.findIndex(u => u.username === currentCallsign) + 1;
            document.getElementById('global-rank-display').innerText = rank > 0 ? `#${rank} WORLD` : "UNRANKED";
        } catch (e) { document.getElementById('global-rank-display').innerText = "OFFLINE"; }
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) return;
        currentCallsign = name;
        document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
        if(!sessionStorage.getItem('manualSeen')) {
            sessionStorage.setItem('manualSeen', 'true');
            showScreen('screen-manual');
        } else { showScreen('screen-modes'); }
    }

    function startGame(mode) {
        selectedMode = mode; tasksCompleted = 0; sessionClout = 0; isPaused = false;
        comboCount = 0; cleanStreakCount = 0; rerunUsedInSession = false; speedDemonCount = 0;
        document.getElementById('clout-val').innerText = "0";
        document.getElementById('perfect-badge').style.display = "none";
        showScreen('screen-game');
        drawTask();
    }

    // FIX: Shuffle card text correctly every time
    function drawTask() {
        if(tasksCompleted >= SET_LIMIT) { endSession(); return; }
        
        document.getElementById('task-count').innerText = `${tasksCompleted + 1}/${SET_LIMIT}`;
        const deck = cardDecks[selectedMode] || cardDecks.production;
        const randomCard = deck[Math.floor(Math.random() * deck.length)];
        document.getElementById('card-body').innerText = randomCard;
        
        timeLeft = TASK_TIME;
        cooldownLeft = 10; 
        updateCooldownUI();
        startTimer();
    }

    function updateCooldownUI() {
        const btn = document.getElementById('complete-btn');
        const timerTxt = document.getElementById('cooldown-timer');
        if (cooldownLeft > 0) {
            btn.classList.add('btn-locked');
            timerTxt.innerText = `LOCKED: ${cooldownLeft}s`;
        } else {
            btn.classList.remove('btn-locked');
            timerTxt.innerText = "READY";
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        const timerEl = document.getElementById('timer');
        timerEl.classList.remove('timer-low');
        timerInterval = setInterval(() => {
            if(!isPaused) {
                timeLeft--;
                if(cooldownLeft > 0) { cooldownLeft--; updateCooldownUI(); }
                if(timeLeft <= 10) timerEl.classList.add('timer-low');
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                timerEl.innerText = (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
                if(timeLeft <= 0) { clearInterval(timerInterval); comboCount = 0; showScreen('screen-modes'); }
            }
        }, 1000);
    }

    function attemptComplete() {
        if(cooldownLeft > 0) { showCheatError(); return; }
        completeTask();
    }

    function showCheatError() {
        const err = document.getElementById('cheat-error');
        err.style.opacity = "1";
        setTimeout(() => err.style.opacity = "0", 2000);
    }

    function completeTask() {
        let currentBonus = 0;
        if (timeLeft > 15) { currentBonus += 5; speedDemonCount++; triggerAlert("SPEED DEMON +5"); }
        tasksCompleted++; 
        sessionClout += (10 + currentBonus);
        comboCount++; cleanStreakCount++;
        
        if(comboCount === 3) { sessionClout += 25; setTimeout(() => triggerAlert("XP OVERDRIVE +25"), 800); comboCount = 0; }
        if(cleanStreakCount === 6 && !rerunUsedInSession) {
            const bonus = Math.floor(Math.random() * 101) + 50; 
            sessionClout += bonus;
            setTimeout(() => triggerAlert(`CLEAN STREAK +${bonus}`), 1600);
        }
        document.getElementById('clout-val').innerText = sessionClout;
        drawTask(); // Shuffle next card
    }

    function triggerAlert(text) {
        const alert = document.getElementById('combo-alert');
        alert.innerText = text; alert.style.opacity = "1";
        setTimeout(() => alert.style.opacity = "0", 2000);
    }

    function rerollTask() { 
        rerunUsedInSession = true; 
        cleanStreakCount = 0; 
        const deck = cardDecks[selectedMode] || cardDecks.production;
        document.getElementById('card-body').innerText = deck[Math.floor(Math.random() * deck.length)];
    }

    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        
        if (!rerunUsedInSession && speedDemonCount >= 5) {
            document.getElementById('perfect-badge').style.display = "block";
            sessionClout += 100;
            const perfects = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
            localStorage.setItem(`perfect_${currentCallsign}`, perfects + 1);
        }

        const currentTotal = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        localStorage.setItem(`clout_${currentCallsign}`, currentTotal + sessionClout);
        document.getElementById('result-clout').innerText = sessionClout;
        const footer = document.getElementById('result-footer');
        footer.innerText = "SYNCING TO GLOBAL RIG...";
        try {
            await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: sessionClout })
            });
            footer.innerText = "RANK UPDATED SUCCESSFULLY.";
        } catch (e) { footer.innerText = "OFFLINE: SAVED TO LOCAL RIG."; }
    }

    function resetAll() { if(confirm("ERASE ALL CAREER PROGRESS?")) { localStorage.clear(); location.reload(); } }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { clearInterval(timerInterval); showScreen('screen-modes'); }
    window.onload = () => showScreen('screen-auth');
</script>
</body>
</html>
