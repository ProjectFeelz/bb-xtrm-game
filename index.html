<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO</title>
    <style>
        :root {
            --bg: #0a0b0e; --panel: #161a1f; --border: #2a2f36;
            --cyan: #00f2ff; --magenta: #ff00ff; --yellow: #f1c40f;
            --green: #2ecc71; --red: #ff4757;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', monospace; }
        body {
            background-color: var(--bg); color: #e0e0e0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: radial-gradient(circle at center, #1a1d23 0%, #0a0b0e 100%);
        }
        #console {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background: var(--panel); border: 2px solid var(--border);
            border-radius: 20px; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; inset: 0; padding: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: var(--panel); z-index: 10;
        }
        .active-screen { display: flex !important; }
        
        .logo-small { font-size: 2rem; font-weight: 900; color: var(--cyan); margin-bottom: 20px; font-style: italic; }
        h2 { font-size: 0.7rem; letter-spacing: 3px; color: #666; text-transform: uppercase; margin-bottom: 15px; text-align: center; }
        
        #leaderboard-panel {
            width: 100%; background: #0a0b0e; border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 20px; padding: 12px; font-size: 0.75rem;
        }
        .lb-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1a1d23; }
        .lb-name { color: #888; text-transform: uppercase; }
        .lb-score { color: var(--yellow); font-weight: bold; }

        .manual-box { width: 100%; background: #0a0b0e; border-radius: 10px; padding: 15px; overflow-y: auto; max-height: 500px; border: 1px solid var(--border); }
        .manual-item { margin-bottom: 18px; font-size: 0.8rem; text-align: left; line-height: 1.4; }
        .manual-item b { color: var(--cyan); display: block; margin-bottom: 4px; font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; }

        input {
            width: 100%; padding: 16px; background: #0a0b0e; border: 1px solid var(--border);
            color: var(--cyan); border-radius: 8px; outline: none; font-size: 1.1rem; text-align: center;
        }
        .btn {
            width: 100%; padding: 18px; border: 1px solid var(--border); border-radius: 12px;
            background: rgba(255,255,255,0.03); color: white; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--cyan); color: black; border: none; }
        .btn-primary:disabled { background: #1a3d42; color: #00828a; cursor: not-allowed; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); font-size: 0.8rem; padding: 12px; }

        #combo-alert { color: var(--magenta); font-weight: 900; font-size: 1rem; position: absolute; top: 110px; opacity: 0; transition: 0.3s; z-index: 20; pointer-events: none; }

        .game-hud { display: flex; justify-content: space-between; width: 100%; margin-bottom: 20px; font-size: 0.8rem; color: #888; }
        .hud-val { color: var(--cyan); font-weight: bold; }
        #timer { font-size: 6rem; color: var(--yellow); font-family: monospace; line-height: 1; margin: 10px 0; }
        #card { width: 100%; flex: 1; border: 2px solid var(--border); background: #121519; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 25px; text-align: center; margin: 15px 0; font-size: 1.4rem; font-weight: 600; }
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        
        .cooldown-text { font-size: 0.6rem; display: block; margin-top: 4px; opacity: 0.7; }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <h2>Registry</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" style="margin-top:20px" onclick="validateAuth()">LOGIN</button>
    </div>

    <div id="screen-manual" class="screen">
        <div class="logo-small">STUDIO OPS</div>
        <div class="manual-box">
            <div class="manual-item"><b>1. CHOOSE YOUR WORKFLOW</b>Select a field (Engineer, Beats, or Writer).</div>
            <div class="manual-item"><b>2. 10s LOCK</b>The "COMPLETE" button is locked for the first 10s of every task. You must actually perform the move in your DAW.</div>
            <div class="manual-item"><b>3. BASE CLOUT</b>Each card = +10 Clout.</div>
            <div class="manual-item"><b>XP OVERDRIVE</b>3 tasks in a row = +25 bonus.</div>
            <div class="manual-item"><b>CLEAN STREAK</b>6 tasks without RERUN = Random Massive Bonus (50-150).</div>
        </div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="showScreen('screen-modes')">INITIALIZE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <h2 id="welcome-msg">WELCOME, ARTIST</h2>
        <div id="leaderboard-panel">
            <div style="text-align: center; color: var(--cyan); margin-bottom: 8px; font-size: 0.6rem; letter-spacing: 2px;">TOP SESSION RECORDS</div>
            <div id="lb-content"><div style="text-align:center; color:#444;">SYNCING...</div></div>
            <div id="user-stats" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                <span style="color: #666;">LIFETIME CLOUT:</span>
                <span id="last-score" style="color: var(--cyan);">0</span>
            </div>
        </div>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('production')">ENGINEER</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('beats')">BEATS</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('songwriting')">WRITER</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;">
            <button class="btn btn-secondary" onclick="showScreen('screen-manual')">INFO</button>
            <button class="btn btn-secondary" onclick="localStorage.clear(); location.reload();">RESET</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="combo-alert">COMBO +25 XP</div>
        <div class="game-hud">
            <span>TASK: <span id="task-count" class="hud-val">1/10</span></span>
            <span>CLOUT: <span id="clout-val" class="hud-val">0</span></span>
        </div>
        <div id="timer">01:00</div>
        <div id="card"><div id="card-body">Awaiting sync...</div></div>
        <div id="game-controls">
            <button id="complete-btn" class="btn btn-primary" style="grid-column: span 2" onclick="completeTask()">
                COMPLETE
                <span id="cooldown-timer" class="cooldown-text"></span>
            </button>
            <button class="btn btn-secondary" onclick="rerollTask()">RERUN</button>
            <button id="pause-btn" class="btn btn-secondary" onclick="togglePause()">PAUSE</button>
            <button class="btn btn-secondary" style="grid-column: span 2; color: var(--red); border-color: #400;" onclick="exitGame()">EJECT</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 id="result-header">SET COMPLETE</h2>
        <div id="result-clout" style="font-size: 4rem; color: var(--yellow)">0</div>
        <p id="result-footer" style="margin-top: 20px;">BANKING CLOUT...</p>
        <button class="btn btn-primary" style="margin-top: 20px" onclick="showScreen('screen-modes')">CONTINUE</button>
    </div>
</div>

<script>
    const SET_LIMIT = 10;
    const cardDecks = {
        production: ['Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements', 'Mute lead instrument', 'Apply 1/8th delay', 'Saturate the Bass', 'Pan hats 30% Right', 'Double vocals', 'Reverse reverb tail', 'Bitcrush melody'],
        songwriting: ['Rhyme with Stone', 'No I, Me, or My', '3 questions', 'Start with previous word', 'Weather metaphor', 'Specific color', '4-line story', 'Alliterate next line', 'End line with verb', 'Write about machine'],
        beats: ['Replace snare with Clap', 'Nudge hats late', 'Pitch kick up', '1-bar drum break', 'Add shaker loop', 'Reverse crash', 'Half-time hats', 'Velocity humanize kicks', 'Woodblock on 4', 'Triple hi-hat speed']
    };

    let sessionClout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', tasksCompleted = 0, currentCallsign = "";
    let comboCount = 0, rerunUsedInSession = false, cleanStreakCount = 0, cooldownLeft = 0;
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
        if(id === 'screen-modes') { loadLeaderboard(); updateLocalDisplay(); }
    }

    function updateLocalDisplay() {
        const savedClout = localStorage.getItem(`clout_${currentCallsign}`) || 0;
        document.getElementById('last-score').innerText = savedClout;
    }

    async function loadLeaderboard() {
        const lbContent = document.getElementById('lb-content');
        try {
            // Added Cache Busting to fix the "Offline" issue
            const res = await fetch(`${API_PATH}/get-scores?t=${Date.now()}`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            lbContent.innerHTML = data.slice(0, 5).map((d, i) => `
                <div class="lb-row"><span class="lb-name">#${i+1} ${d.username}</span><span class="lb-score">${d.clout}</span></div>
            `).join('') || '<div style="text-align:center">NO DATA YET</div>';
        } catch (e) { 
            lbContent.innerHTML = '<div style="text-align:center; color:var(--red)">OFFLINE - SYNC FAILED</div>'; 
        }
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) return;
        currentCallsign = name;
        document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
        if(!sessionStorage.getItem('manualSeen')) {
            sessionStorage.setItem('manualSeen', 'true');
            showScreen('screen-manual');
        } else {
            showScreen('screen-modes');
        }
    }

    function startGame(mode) {
        selectedMode = mode; tasksCompleted = 0; sessionClout = 0; isPaused = false;
        comboCount = 0; cleanStreakCount = 0; rerunUsedInSession = false;
        document.getElementById('clout-val').innerText = "0";
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if(tasksCompleted >= SET_LIMIT) { endSession(); return; }
        document.getElementById('task-count').innerText = `${tasksCompleted + 1}/${SET_LIMIT}`;
        const deck = cardDecks[selectedMode] || cardDecks.production;
        document.getElementById('card-body').innerText = deck[Math.floor(Math.random() * deck.length)];
        
        timeLeft = 60;
        cooldownLeft = 10; // 10 Second Cheat-Gate
        updateCooldown();
        startTimer();
    }

    function updateCooldown() {
        const btn = document.getElementById('complete-btn');
        const timerTxt = document.getElementById('cooldown-timer');
        if (cooldownLeft > 0) {
            btn.disabled = true;
            timerTxt.innerText = `LOCKED: ${cooldownLeft}s`;
        } else {
            btn.disabled = false;
            timerTxt.innerText = "READY";
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!isPaused) {
                timeLeft--;
                if(cooldownLeft > 0) {
                    cooldownLeft--;
                    updateCooldown();
                }
                
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer').innerText = (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
                if(timeLeft <= 0) { clearInterval(timerInterval); comboCount = 0; showScreen('screen-modes'); }
            }
        }, 1000);
    }

    function completeTask() {
        tasksCompleted++; 
        sessionClout += 10;
        comboCount++;
        cleanStreakCount++;

        if(comboCount === 3) { sessionClout += 25; triggerAlert("XP OVERDRIVE +25"); comboCount = 0; }
        if(cleanStreakCount === 6 && !rerunUsedInSession) {
            const bonus = Math.floor(Math.random() * 101) + 50; 
            sessionClout += bonus;
            triggerAlert(`CLEAN STREAK +${bonus}`);
        }

        document.getElementById('clout-val').innerText = sessionClout;
        drawTask();
    }

    function triggerAlert(text) {
        const alert = document.getElementById('combo-alert');
        alert.innerText = text; alert.style.opacity = "1";
        setTimeout(() => alert.style.opacity = "0", 2000);
    }

    function rerollTask() {
        rerunUsedInSession = true;
        cleanStreakCount = 0; 
        const deck = cardDecks[selectedMode] || cardDecks.production;
        document.getElementById('card-body').innerText = deck[Math.floor(Math.random() * deck.length)];
        // Reroll does NOT reset the 10s cooldown to keep gameplay fluid
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE";
    }

    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        const currentTotal = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        localStorage.setItem(`clout_${currentCallsign}`, currentTotal + sessionClout);
        document.getElementById('result-clout').innerText = sessionClout;
        const footer = document.getElementById('result-footer');
        footer.innerText = "SYNCING TO GLOBAL RIG...";
        try {
            await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: sessionClout })
            });
            footer.innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { footer.innerText = "OFFLINE: SAVED TO LOCAL RIG."; }
    }

    function exitGame() { clearInterval(timerInterval); showScreen('screen-modes'); }
    window.onload = () => showScreen('screen-auth');
</script>
</body>
</html>
