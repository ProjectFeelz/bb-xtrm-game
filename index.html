<script>
    const SET_LIMIT = 10;
    const cardDecks = {
        production: ['Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements', 'Mute lead instrument', 'Apply 1/8th delay', 'Saturate the Bass', 'Pan hats 30% Right', 'Double vocals', 'Reverse reverb tail', 'Bitcrush melody'],
        songwriting: ['Rhyme with Stone', 'No I, Me, or My', '3 questions', 'Start with previous word', 'Weather metaphor', 'Specific color', '4-line story', 'Alliterate next line', 'End line with verb', 'Write about machine'],
        beats: ['Replace snare with Clap', 'Nudge hats late', 'Pitch kick up', '1-bar drum break', 'Add shaker loop', 'Reverse crash', 'Half-time hats', 'Velocity humanize kicks', 'Woodblock on 4', 'Triple hi-hat speed']
    };

    let sessionClout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', tasksCompleted = 0, currentCallsign = "";
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
        if(id === 'screen-modes') {
            loadLeaderboard();
            updateLocalDisplay();
        }
    }

    // --- NEW: PERSISTENCE LOGIC ---
    function updateLocalDisplay() {
        // Get total clout from localStorage for this specific artist
        const savedClout = localStorage.getItem(`clout_${currentCallsign}`) || 0;
        document.getElementById('last-score').innerText = savedClout + " TOTAL CLOUT";
    }

    async function loadLeaderboard() {
        const lbContent = document.getElementById('lb-content');
        try {
            const res = await fetch(`${API_PATH}/get-scores`);
            const data = await res.json();
            lbContent.innerHTML = data.slice(0, 5).map((d, i) => `
                <div class="lb-row">
                    <span class="lb-name">#${i+1} ${d.username}</span>
                    <span class="lb-score">${d.clout}</span>
                </div>
            `).join('') || '<div style="text-align:center">NO DATA YET</div>';
        } catch (e) {
            lbContent.innerHTML = '<div style="text-align:center; color:var(--red)">OFFLINE</div>';
        }
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) return;
        currentCallsign = name;
        document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
        showScreen('screen-modes');
    }

    function startGame(mode) {
        selectedMode = mode;
        tasksCompleted = 0; 
        sessionClout = 0; // Score for THIS session
        isPaused = false;
        document.getElementById('clout-val').innerText = "0";
        showScreen('screen-game');
        drawTask();
    }

    function completeTask() {
        tasksCompleted++; 
        sessionClout += 10;
        document.getElementById('clout-val').innerText = sessionClout;
        drawTask();
    }

    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        
        // Update Local Storage (All-time total)
        const currentTotal = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        const newTotal = currentTotal + sessionClout;
        localStorage.setItem(`clout_${currentCallsign}`, newTotal);

        document.getElementById('result-artist').innerText = `ARTIST: ${currentCallsign}`;
        document.getElementById('result-clout').innerText = sessionClout;
        
        const footer = document.getElementById('result-footer');
        footer.innerText = "SYNCING TO GLOBAL RIG...";
        
        try {
            // Note: Sending the sessionClout to Supabase, but you could also send 'newTotal'
            await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: sessionClout })
            });
            footer.innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { 
            footer.innerText = "LOCAL SAVE ONLY."; 
        }
    }
    
    // ... rest of your timer, drawTask, and reroll functions ...
</script>
