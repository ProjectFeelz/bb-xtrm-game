<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO RIG</title>
    <style>
        :root {
            --steel-light: #e5e7eb;
            --steel-mid: #9ca3af;
            --steel-dark: #374151;
            --tape-black: #050505;
            --cyan: #00f2ff;
            --magenta: #ff00ff;
            --yellow: #f1c40f;
            --red: #ff4757;
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Courier New', monospace; }

        body {
            background-color: #000;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* BRUSHED STAINLESS STEEL CHASSIS */
        #console {
            width: 100%;
            max-width: 420px;
            height: 92vh;
            border-radius: 40px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 4px solid #333;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9), inset 0 0 40px #000;
            background: linear-gradient(135deg, #444 0%, #888 50%, #444 100%);
        }

        #console::before {
            content: "";
            position: absolute;
            inset: 0;
            opacity: 0.12;
            pointer-events: none;
            background-image: repeating-linear-gradient(45deg, #fff 0px, #fff 1px, transparent 1px, transparent 2px);
            z-index: 1;
        }

        .screen {
            position: absolute;
            inset: 22px;
            background: var(--tape-black);
            border: 3px solid #111;
            border-radius: 20px;
            padding: 25px;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.05);
        }

        .active-screen { display: flex !important; }

        /* CRT SCANLINE */
        .screen::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 100;
        }

        .logo-small { font-size: 2.8rem; font-weight: 900; color: var(--cyan); text-shadow: var(--neon-glow); font-style: italic; margin-bottom: 5px; }
        
        /* 3D TACTILE BUTTONS */
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(180deg, #444 0%, #222 48%, #111 52%, #000 100%);
            color: var(--cyan);
            border: 1px solid #555;
            border-radius: 12px;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            margin-bottom: 12px;
            box-shadow: 0 5px 0 #000, inset 0 1px 2px rgba(255,255,255,0.2);
            position: relative;
            z-index: 20;
        }

        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #000; }
        .btn-primary { background: linear-gradient(180deg, #008b8b 0%, #004d4d 48%, #002b2b 52%, #000 100%); border-color: var(--cyan); }
        .btn-secondary { font-size: 0.75rem; color: #777; background: linear-gradient(180deg, #2a2a2a, #050505); border-color: #333; }

        #timer { font-size: 4rem; color: var(--yellow); font-weight: bold; margin: 10px 0; }
        #card { width: 100%; flex: 1; border: 1px solid #222; background: #080808; border-radius: 15px; display: flex; align-items: center; justify-content: center; padding: 25px; color: #eee; text-align: center; margin-bottom: 15px; box-shadow: inset 0 0 20px #000; }
        
        input { width: 100%; padding: 18px; background: #080808; border: 1px solid #222; color: var(--cyan); border-radius: 10px; text-align: center; font-size: 1.2rem; margin-bottom: 15px; outline: none; box-shadow: inset 0 4px 12px rgba(0,0,0,1); }

        /* TAPE LOADING ANIMATION */
        @keyframes tapeIn {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            30% { transform: scale(1) translateY(0); opacity: 1; } /* The 'Click' */
            100% { filter: brightness(1.2); } /* The 'Whirr' */
        }
        .tape-sequence { animation: tapeIn 0.6s cubic-bezier(0.2, 0, 0.2, 1); }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <div style="color:var(--magenta); letter-spacing: 3px; font-size: 0.8rem; margin-bottom: 30px;">ðŸ”’ SIGN IN</div>
        <input type="text" id="username" placeholder="ARTIST NAME" spellcheck="false">
        <button class="btn btn-primary" onclick="validateAuth()">ENGAGE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <h2 id="welcome-msg" style="color:var(--cyan); font-size: 0.7rem; margin-bottom: 15px;">WELCOME, ARTIST</h2>
        <div style="width: 100%; background: #000; border: 1px solid #1a1a1a; border-radius: 15px; padding: 20px; margin-bottom: 25px; text-align: center;">
            <div style="color: #444; font-size: 0.6rem; letter-spacing: 2px;">GLOBAL STATUS</div>
            <div style="font-size: 2rem; color: var(--cyan); font-weight: 900;">#1 WORLD</div>
        </div>
        <button class="btn" onclick="loadTape('ENGINEER')">ENGINEER</button>
        <button class="btn" onclick="loadTape('BEATS')">BEATS</button>
        <button class="btn" onclick="loadTape('WRITER')">WRITER</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; margin-top: auto;">
            <button class="btn btn-secondary" onclick="location.reload()">RESET</button>
            <button class="btn btn-secondary">MANUAL</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="display: flex; justify-content: space-between; width: 100%; font-size: 0.75rem; color: #444;">
            <span>TASK: <span style="color: var(--cyan)">1/10</span></span>
            <span>CLOUT: <span style="color: var(--cyan)">0</span></span>
        </div>
        <div id="timer">00:30</div>
        <div id="card">Awaiting Tape...</div>
        <button class="btn btn-primary">COMPLETE</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%;">
            <button class="btn btn-secondary">RERUN</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-modes')">EJECT</button>
        </div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playTapeSound() {
        // Simulating the "Click-Clack" (Mechanical Load)
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);

        // Simulating the "Whirr" (Motor start)
        setTimeout(() => {
            const whirr = audioCtx.createOscillator();
            const whirrGain = audioCtx.createGain();
            whirr.type = 'sawtooth';
            whirr.frequency.setValueAtTime(60, audioCtx.currentTime);
            whirr.frequency.linearRampToValueAtTime(80, audioCtx.currentTime + 0.4);
            whirrGain.gain.setValueAtTime(0.03, audioCtx.currentTime);
            whirrGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            whirr.connect(whirrGain);
            whirrGain.connect(audioCtx.destination);
            whirr.start();
            whirr.stop(audioCtx.currentTime + 0.5);
        }, 150);
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) return;
        document.getElementById('welcome-msg').innerText = `WELCOME, ${name}`;
        showScreen('screen-modes');
    }

    function loadTape(mode) {
        playTapeSound();
        showScreen('screen-game');
        const card = document.getElementById('card');
        card.classList.remove('tape-sequence');
        void card.offsetWidth; // Trigger reflow
        card.classList.add('tape-sequence');
        card.innerText = `LOADING ${mode} DATA...`;
    }

    window.onload = () => showScreen('screen-auth');
</script>
</body>
</html>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <h2>Registry</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" onclick="validateAuth()">ENGAGE RIG</button>
    </div>

    <div id="screen-manual" class="screen">
        <div class="logo-small" style="font-size: 1.5rem; color:var(--magenta)">STUDIO OPS</div>
        <div style="text-align: left; font-size: 0.7rem; line-height: 1.4; background: #000; padding: 15px; border: 1px solid #333; border-radius: 10px;">
            <b style="color:var(--red)">â€¢ HIGH STAKES:</b> 30s per task. Timer hits zero = Session Over.<br><br>
            <b style="color:var(--cyan)">â€¢ SECURITY LOCK:</b> 'COMPLETE' is locked for the first 10s.<br><br>
            <b style="color:var(--green)">â€¢ SPEED DEMON:</b> Submit with >15s left for +5 Clout.<br><br>
            <b style="color:var(--yellow)">â€¢ PERFECT SET:</b> 0 Reruns + 5 Speed bonuses = GOLD STATUS.
        </div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="showScreen('screen-modes')">INITIALIZE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <h2 id="welcome-msg" style="color:var(--cyan)">WELCOME, ARTIST</h2>
        <div id="rank-panel">
            <div style="color: #444; font-size: 0.6rem; letter-spacing: 2px;">GLOBAL STATUS</div>
            <div id="global-rank-display" style="font-size: 1.8rem; color: var(--cyan); font-weight: 900;">RANKING...</div>
            <div id="last-score" style="color: var(--yellow); font-size: 0.7rem;">0 LIFETIME CLOUT</div>
            <div id="badge-container" class="badge-row"></div>
        </div>
        <button class="btn" onclick="startGame('production')">ENGINEER</button>
        <button class="btn" onclick="startGame('beats')">BEATS</button>
        <button class="btn" onclick="startGame('songwriting')">WRITER</button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: auto;">
            <button class="btn btn-secondary" onclick="showScreen('screen-manual')">MANUAL</button>
            <button class="btn btn-secondary" style="color:var(--red)" onclick="resetAll()">RESET</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-hud">
            <span>TASK: <span id="task-count" class="hud-val">1/10</span></span>
            <span>CLOUT: <span id="clout-val" class="hud-val">0</span></span>
        </div>
        <div id="cheat-error">!! SECURITY: COMPLETE LOCKED !!</div>
        <div id="timer">00:30</div>
        <div id="combo-alert">XP OVERDRIVE +25</div>
        <div id="card"><div id="card-body">Awaiting sync...</div></div>
        
        <button id="complete-btn" class="btn btn-primary" onclick="attemptComplete()">
            COMPLETE
            <span id="cooldown-timer" class="cooldown-text">LOCKED</span>
        </button>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;">
            <button class="btn btn-secondary" onclick="rerollTask()">RERUN</button>
            <button id="pause-btn" class="btn btn-secondary" onclick="togglePause()">PAUSE</button>
        </div>
        <button class="btn btn-secondary" style="color:var(--red); border-color:#400; margin-top: 10px;" onclick="exitGame()">EJECT RIG</button>
    </div>

    <div id="screen-results" class="screen">
        <h2 id="result-header">SET COMPLETE</h2>
        <div id="result-clout" style="font-size: 4rem; color: var(--yellow)">0</div>
        <div id="perfect-badge" style="display:none; color: var(--yellow); border: 1px solid var(--yellow); padding: 5px 15px; border-radius: 20px; font-size: 0.7rem; font-weight: bold;">GOLD STATUS</div>
        <p id="result-footer" style="margin-top: 20px; font-size: 0.6rem; color: #666;">BANKING CLOUT...</p>
        <button class="btn btn-primary" style="margin-top: 20px" onclick="showScreen('screen-modes')">CONTINUE</button>
    </div>
</div>

<script>
    // --- AUDIO ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playTone(freq, type, duration, vol = 0.1) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    const sfx = {
        click: () => playTone(150, 'sine', 0.1, 0.2),
        error: () => { playTone(100, 'sawtooth', 0.2, 0.1); playTone(80, 'sawtooth', 0.2, 0.1); },
        success: () => { playTone(600, 'sine', 0.2, 0.1); setTimeout(()=>playTone(800, 'sine', 0.3, 0.1), 50); },
        tick: (isLow) => playTone(isLow ? 1200 : 800, 'square', 0.05, 0.03),
        xp: () => { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => playTone(f, 'sine', 0.4, 0.1), i * 100)); },
        boot: () => { playTone(200, 'sine', 1, 0.2); playTone(400, 'sine', 1, 0.1); }
    };

    // --- GAME LOGIC ---
    const SET_LIMIT = 10;
    const TASK_TIME = 30; 
    const cardDecks = {
        production: ['Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements','Mute lead instrument','Apply 1/8th delay','Saturate the Bass','Pan hats 30% Right', 'Double vocals', 'Reverse reverb tail', 'Bitcrush melody','Add 20% swing to midi', 'Sidechain pad to kick', 'Boost 3k on vocals','Automate a low-pass sweep', 'Add a foley texture', 'Clip the master peak','Stereo widen the chorus', 'Mono the sub-bass', 'Add a 1-bar silent gap','Shift a melody up 1 octave', 'Apply a chorus effect to bass', 'Gating on the pads','Distort the parallel bus', 'Ping-pong delay on hats', 'Shorten all kick decays'],
        songwriting: ['Rhyme with Stone', 'No I, Me, or My', '3 questions in a row','Start with previous word', 'Weather metaphor', 'Specific color mentioned','4-line mini story', 'Alliterate next line', 'End line with a verb', 'Write about a machine','Describe a smell', 'Use a word with 4+ syllables', 'Reference a 90s movie','Write a 2-line whisper part', 'Change the perspective to "Them"', 'A line about a clock','Rhyme scheme AABB', 'Internal rhyme only', 'Reference a city name','No words ending in "ing"', 'Start a line with "Never"', 'Add a technical term'],
        beats: ['Replace snare with Clap', 'Nudge hats 5ms late', 'Pitch kick up 2 semitones','1-bar drum break', 'Add shaker loop', 'Reverse the crash','Half-time the hi-hats', 'Velocity humanize kicks', 'Woodblock on the 4', 'Triple hi-hat speed','Delete every 4th kick', 'Add a rimshot on the "and"', 'Ghost note snares','Flanger on the drum bus', 'Pitch down the hats', 'Replace kick with a tom','Add a tambourine on 2 and 4', 'Randomize hat velocities', 'Add a cowbell hit','Filter the drums for 2 bars', 'Roll the snare at the end']
    };

    let sessionClout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', tasksCompleted = 0, currentCallsign = "";
    let comboCount = 0, rerunUsedInSession = false, speedDemonCount = 0, cooldownLeft = 0;
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        sfx.click();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
        if(id === 'screen-modes') { updateRankDisplay(); renderBadges(); }
    }

    function renderBadges() {
        const count = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
        const container = document.getElementById('badge-container');
        container.innerHTML = '';
        for(let i=0; i<count; i++) {
            const b = document.createElement('div');
            b.className = 'mini-badge';
            container.appendChild(b);
        }
    }

    async function updateRankDisplay() {
        const savedClout = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        document.getElementById('last-score').innerText = `${savedClout} LIFETIME CLOUT`;
        try {
            const res = await fetch(`${API_PATH}/get-scores?t=${Date.now()}`);
            const data = await res.json();
            const sorted = data.sort((a,b) => b.clout - a.clout);
            const rank = sorted.findIndex(u => u.username === currentCallsign) + 1;
            document.getElementById('global-rank-display').innerText = rank > 0 ? `#${rank} WORLD` : "UNRANKED";
        } catch (e) { document.getElementById('global-rank-display').innerText = "OFFLINE"; }
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) { sfx.error(); return; }
        currentCallsign = name;
        sfx.boot();
        document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
        if(!sessionStorage.getItem('manualSeen')) {
            sessionStorage.setItem('manualSeen', 'true');
            showScreen('screen-manual');
        } else { showScreen('screen-modes'); }
    }

    function startGame(mode) {
        selectedMode = mode; tasksCompleted = 0; sessionClout = 0; isPaused = false;
        comboCount = 0; rerunUsedInSession = false; speedDemonCount = 0;
        document.getElementById('clout-val').innerText = "0";
        document.getElementById('perfect-badge').style.display = "none";
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if(tasksCompleted >= SET_LIMIT) { endSession(); return; }
        const cardBody = document.getElementById('card-body');
        cardBody.classList.remove('card-load');
        cardBody.classList.add('card-eject');
        
        setTimeout(() => {
            document.getElementById('task-count').innerText = `${tasksCompleted + 1}/${SET_LIMIT}`;
            const deck = cardDecks[selectedMode] || cardDecks.production;
            cardBody.innerText = deck[Math.floor(Math.random() * deck.length)];
            cardBody.classList.remove('card-eject');
            cardBody.classList.add('card-load');
            timeLeft = TASK_TIME;
            cooldownLeft = 10; 
            updateCooldownUI();
            startTimer();
        }, 300);
    }

    function updateCooldownUI() {
        const btn = document.getElementById('complete-btn');
        const timerTxt = document.getElementById('cooldown-timer');
        if (cooldownLeft > 0) {
            btn.classList.add('btn-locked');
            timerTxt.innerText = `LOCKED: ${cooldownLeft}s`;
        } else {
            btn.classList.remove('btn-locked');
            timerTxt.innerText = "READY";
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        const timerEl = document.getElementById('timer');
        timerEl.classList.remove('timer-low');
        timerInterval = setInterval(() => {
            if(!isPaused) {
                timeLeft--;
                if(cooldownLeft > 0) { cooldownLeft--; updateCooldownUI(); }
                
                sfx.tick(timeLeft <= 10);
                if(timeLeft <= 10) timerEl.classList.add('timer-low');
                
                const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                timerEl.innerText = (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
                
                if(timeLeft <= 0) { 
                    clearInterval(timerInterval); 
                    sfx.error();
                    showScreen('screen-modes'); 
                }
            }
        }, 1000);
    }

    function attemptComplete() {
        if(cooldownLeft > 0) { 
            sfx.error();
            showCheatError(); 
            return; 
        }
        sfx.success();
        completeTask();
    }

    function showCheatError() {
        const err = document.getElementById('cheat-error');
        err.style.opacity = "1";
        setTimeout(() => err.style.opacity = "0", 2000);
    }

    function completeTask() {
        let currentBonus = 0;
        if (timeLeft > 15) { 
            currentBonus += 5; 
            speedDemonCount++; 
            triggerAlert("SPEED DEMON +5"); 
        }
        tasksCompleted++; 
        sessionClout += (10 + currentBonus);
        comboCount++; 
        
        if(comboCount === 3) { 
            sessionClout += 25; 
            setTimeout(() => {
                sfx.xp();
                triggerAlert("XP OVERDRIVE +25");
            }, 500); 
            comboCount = 0; 
        }
        document.getElementById('clout-val').innerText = sessionClout;
        drawTask();
    }

    function triggerAlert(text) {
        const alert = document.getElementById('combo-alert');
        alert.innerText = text; alert.style.opacity = "1";
        setTimeout(() => alert.style.opacity = "0", 2000);
    }

    function rerollTask() { 
        sfx.click();
        rerunUsedInSession = true; 
        const deck = cardDecks[selectedMode] || cardDecks.production;
        const cardBody = document.getElementById('card-body');
        cardBody.classList.remove('card-load');
        cardBody.classList.add('card-eject');
        setTimeout(() => {
            cardBody.innerText = deck[Math.floor(Math.random() * deck.length)];
            cardBody.classList.remove('card-eject');
            cardBody.classList.add('card-load');
        }, 300);
    }

    async function endSession() {
        clearInterval(timerInterval);
        sfx.xp();
        showScreen('screen-results');
        if (!rerunUsedInSession && speedDemonCount >= 5) {
            document.getElementById('perfect-badge').style.display = "block";
            sessionClout += 100;
            const perfects = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
            localStorage.setItem(`perfect_${currentCallsign}`, perfects + 1);
        }
        const currentTotal = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        localStorage.setItem(`clout_${currentCallsign}`, currentTotal + sessionClout);
        document.getElementById('result-clout').innerText = sessionClout;
        
        try {
            await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: sessionClout })
            });
            document.getElementById('result-footer').innerText = "RANK UPDATED.";
        } catch (e) { document.getElementById('result-footer').innerText = "OFFLINE MODE."; }
    }

    function resetAll() { if(confirm("ERASE ALL CAREER PROGRESS?")) { sfx.error(); localStorage.clear(); location.reload(); } }
    function togglePause() { sfx.click(); isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { sfx.click(); clearInterval(timerInterval); showScreen('screen-modes'); }
    window.onload = () => showScreen('screen-auth');
</script>
</body>
</html>
