<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO</title>
    <style>
        :root {
            --bg: #0a0b0e;
            --panel: #1a1d26;
            --border: #2a2f36;
            --cyan: #00d9ff;
            --magenta: #ff00ff;
            --yellow: #f1c40f;
            --green: #2ecc71;
            --red: #ff4757;
            --screen-reflection: #003d47;
            --metal-light: #4a5568;
            --metal-dark: #1a1d23;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Courier New', monospace; }
        
        body {
            background: #000;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #console {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 850px;
            position: relative;
            background: linear-gradient(145deg, var(--metal-light), var(--metal-dark));
            border-radius: 24px;
            padding: 22px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.8),
                inset 0 1px 2px rgba(255,255,255,0.1),
                inset 0 -1px 2px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }
        
        #console::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, 
                rgba(255,255,255,0.05) 0%, 
                transparent 50%, 
                rgba(0,0,0,0.3) 100%);
            border-radius: 24px;
            pointer-events: none;
            z-index: 1;
        }
        
        .screen {
            position: absolute;
            inset: 22px;
            padding: 30px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 10;
            border-radius: 12px;
            box-shadow: 
                inset 0 0 40px rgba(0,217,255,0.15);
            background-image: 
                repeating-linear-gradient(0deg, 
                    rgba(0,217,255,0.03) 0px, 
                    transparent 1px, 
                    transparent 2px, 
                    rgba(0,217,255,0.03) 3px);
        }
        
        .active-screen { 
            display: flex !important; 
            z-index: 20 !important;
        }
        
        .logo-small { 
            font-size: 3.5rem; 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--cyan), #00a8cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            margin-top: -40px;
            font-style: italic;
            letter-spacing: 8px;
            line-height: 1;
            text-align: center;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6)) drop-shadow(0 0 30px rgba(0,217,255,0.8));
        }
        
        h2 { 
            font-size: 0.7rem; 
            letter-spacing: 3px; 
            color: var(--magenta); 
            text-transform: uppercase; 
            margin-bottom: 15px; 
            text-align: center;
        }
        
        #rank-panel {
            width: 100%;
            background: linear-gradient(145deg, #0d0f14, #000);
            border: 1px solid var(--screen-reflection);
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        #career-stats { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .badge-row { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 5px; }
        .mini-badge { 
            width: 12px; 
            height: 12px; 
            background: radial-gradient(circle, var(--yellow), #c29d0b);
            border-radius: 50%; 
            box-shadow: 0 0 8px var(--yellow), inset 0 1px 2px rgba(255,255,255,0.3);
        }

        #cheat-error { 
            color: var(--red); 
            font-weight: bold; 
            font-size: 0.75rem; 
            letter-spacing: 1px; 
            opacity: 0; 
            transition: 0.2s; 
            height: 15px; 
            margin-bottom: 5px; 
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--red);
        }

        input {
            width: 100%;
            padding: 16px;
            background: #000;
            border: 2px solid var(--cyan);
            color: var(--cyan);
            border-radius: 8px;
            outline: none;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 
                inset 0 2px 8px rgba(0,0,0,0.8),
                0 0 15px rgba(0,217,255,0.2);
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(145deg, #2a2f36, #1a1d23, #0d0f14, #000);
            color: white;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            transition: 0.2s;
            position: relative;
            box-shadow: 
                0 4px 0 #000,
                0 6px 12px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .btn:active {
            transform: translateY(4px);
            box-shadow: 
                0 0 0 #000,
                0 2px 6px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .btn-primary { 
            background: linear-gradient(145deg, #00f0ff, #00d9ff, #00a8cc, #007a8c);
            color: black;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
            box-shadow: 
                0 4px 0 #005a6a,
                0 6px 12px rgba(0,217,255,0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .btn-primary:active {
            box-shadow: 
                0 0 0 #005a6a,
                0 2px 6px rgba(0,217,255,0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        
        .btn-locked { 
            background: linear-gradient(145deg, #1a1d23, #0d0f14, #000, #000) !important;
            color: #444 !important;
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: 
                0 4px 0 #000,
                0 6px 12px rgba(0,0,0,0.5),
                inset 0 2px 10px rgba(0,0,0,0.8) !important;
        }
        
        .btn-secondary { 
            background: linear-gradient(145deg, #1a1d23, #0d0f14, #000, #000);
            font-size: 0.8rem;
            padding: 12px;
            box-shadow: 
                0 3px 0 #000,
                0 5px 10px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }

        #combo-alert { 
            color: var(--magenta); 
            font-weight: 900; 
            font-size: 1.2rem; 
            margin-top: -10px; 
            margin-bottom: 10px; 
            opacity: 0; 
            transition: 0.3s; 
            z-index: 20; 
            height: 20px; 
            text-align: center;
            text-shadow: 0 0 15px var(--magenta);
        }

        .game-hud { 
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
            margin-bottom: 10px; 
            font-size: 0.8rem; 
            color: #888;
        }
        .hud-val { color: var(--cyan); font-weight: bold; }
        
        #timer { 
            font-size: 6rem; 
            color: var(--yellow); 
            font-family: 'Courier New', monospace; 
            line-height: 1; 
            margin: 0;
            text-shadow: 0 0 20px var(--yellow);
        }
        .timer-low { 
            color: var(--red) !important; 
            animation: pulse 0.5s infinite;
            text-shadow: 0 0 30px var(--red) !important;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        #card { 
            width: 100%; 
            flex: 1; 
            border: 2px solid var(--cyan); 
            background: #000;
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 25px; 
            text-align: center; 
            margin: 15px 0; 
            font-size: 1.4rem; 
            font-weight: 600;
            position: relative;
            overflow: hidden;
            box-shadow: 
                inset 0 2px 15px rgba(0,0,0,0.8),
                0 0 20px rgba(0,217,255,0.3);
        }
        
        #card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0,217,255,0.1), 
                transparent);
            animation: cassette-scan 2s infinite;
        }
        
        @keyframes cassette-scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .cassette-load {
            animation: cassette-insert 0.6s ease-out;
        }
        
        @keyframes cassette-insert {
            0% { 
                transform: translateY(-100%) scale(0.9);
                opacity: 0;
            }
            60% {
                transform: translateY(5%);
            }
            100% { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        
        #perfect-badge { 
            display: none; 
            color: var(--yellow); 
            border: 2px solid var(--yellow);
            padding: 10px 20px; 
            border-radius: 50px; 
            font-size: 0.8rem; 
            font-weight: 900;
            margin-top: 15px; 
            animation: glow 1.5s infinite alternate;
            box-shadow: 0 0 20px var(--yellow);
        }
        @keyframes glow { 
            from { box-shadow: 0 0 10px var(--yellow); } 
            to { box-shadow: 0 0 30px var(--yellow); } 
        }

        .cooldown-text { 
            font-size: 0.6rem; 
            display: block; 
            margin-top: 4px; 
            opacity: 0.7; 
            font-weight: normal;
        }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen active-screen">
        <div class="logo-small">BB XTRM</div>
        <h2>SIGN IN</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" style="margin-top:20px" onclick="validateAuth()">ENGAGE RIG</button>
    </div>

    <div id="screen-manual" class="screen">
        <div style="font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, var(--cyan), #00a8cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; font-style: italic; letter-spacing: 6px; text-align: center; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.6)) drop-shadow(0 0 20px rgba(0,217,255,0.6));">HOW TO</div>
        <div style="text-align: left; font-size: 0.75rem; line-height: 1.5; background: #000; padding: 20px; border-radius: 12px; border: 1px solid var(--screen-reflection);">
            <b style="color:var(--red)">â€¢ HIGH STAKES:</b> You have exactly 30s to complete each task. If the timer hits zero, the session ends. <br><br>
            <b style="color:var(--cyan)">â€¢ 10s SECURITY LOCK:</b> The 'COMPLETE' button is hard-locked for the first 10s of every card. Focus on the craft during this time.<br><br>
            <b style="color:var(--green)">â€¢ SPEED DEMON:</b> Submit your task with more than 15s left on the clock to earn +5 bonus Clout.<br><br>
            <b style="color:var(--magenta)">â€¢ XP COMBO:</b> Chain 3 tasks without a RERUN or failure to trigger +25 XP Overdrive.<br><br>
            <b style="color:var(--yellow)">â€¢ PERFECT SET:</b> Complete all 10 tasks with 0 RERUNS and 5+ SPEED bonuses to earn a Career Trophy and +100 Clout.
        </div>
        <button class="btn btn-primary" style="margin-top:20px" onclick="showScreen('screen-modes')">INITIALIZE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <h2 id="welcome-msg">WELCOME, ARTIST</h2>
        <div id="rank-panel">
            <div style="color: #666; font-size: 0.6rem; letter-spacing: 2px; margin-bottom: 5px;">PERSONAL BEST</div>
            <div id="global-rank-display" style="font-size: 2.2rem; color: var(--cyan); font-weight: 900;">0</div>
            <div id="last-score" style="color: #888; font-size: 0.65rem; margin-top: 8px;">0 LIFETIME CLOUT</div>
            <div id="streak-display" style="margin-top: 10px; padding: 10px; background: #0a0b0e; border-radius: 8px; border: 1px solid var(--border);">
                <div style="color: var(--magenta); font-size: 0.6rem; letter-spacing: 1px; margin-bottom: 3px;">DAILY STREAK</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 1.8rem; color: var(--yellow); font-weight: 900;">ðŸ”¥</span>
                    <span id="streak-count" style="font-size: 1.5rem; color: var(--yellow); font-weight: 900;">0</span>
                    <span style="font-size: 0.7rem; color: #666;">DAYS</span>
                </div>
            </div>
            <div id="career-stats">
                <div style="color: #444; font-size: 0.55rem; letter-spacing: 1px;">PERFECT SET HISTORY</div>
                <div id="badge-container" class="badge-row"></div>
            </div>
        </div>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('production')">ENGINEER</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('beats')">BEATS</button>
        <button class="btn" style="margin-bottom:10px" onclick="startGame('songwriting')">WRITER</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-manual')">MANUAL</button>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-hud">
            <span>TASK: <span id="task-count" class="hud-val">1/10</span></span>
            <span>SESSION: <span id="clout-val" class="hud-val">0</span></span>
        </div>
        <div id="cheat-error">!! SECURITY TRIGGERED: COMPLETE TOO EARLY !!</div>
        <div id="timer">00:30</div>
        <div id="combo-alert">XP OVERDRIVE +25</div>
        <div id="card"><div id="card-body">Awaiting sync...</div></div>
        <div id="game-controls">
            <button id="complete-btn" class="btn btn-primary" style="grid-column: span 2" onclick="attemptComplete()">
                COMPLETE
                <span id="cooldown-timer" class="cooldown-text">LOCKED</span>
            </button>
            <button class="btn btn-secondary" onclick="rerollTask()">RERUN (-5)</button>
            <button class="btn btn-secondary" onclick="restartSession()">RESTART</button>
            <button class="btn btn-secondary" style="grid-column: span 2; color: var(--red); border-color: #400;" onclick="exitGame()">EJECT</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 id="result-header">SET COMPLETE</h2>
        <div id="result-clout" style="font-size: 4rem; color: var(--yellow); text-shadow: 0 0 30px var(--yellow);">0</div>
        <div id="perfect-badge">PERFECT SET // GOLD STATUS</div>
        <p id="result-footer" style="margin-top: 20px;">BANKING CLOUT...</p>
        <button class="btn btn-primary" style="margin-top: 20px" onclick="showScreen('screen-modes')">CONTINUE</button>
    </div>
</div>

<script>
    // Audio System
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    function playClick() {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.1, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
        osc.start();
        osc.stop(audioContext.currentTime + 0.05);
    }
    
    function playTick() {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = 1200;
        gain.gain.setValueAtTime(0.03, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.03);
        osc.start();
        osc.stop(audioContext.currentTime + 0.03);
    }
    
    function playAlarmBuzz(intensity) {
        // intensity from 0 to 1 (increases as time runs out)
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = 'sawtooth';
        osc.frequency.value = 220 + (intensity * 180); // pitch rises with intensity
        gain.gain.setValueAtTime(0.08 + (intensity * 0.12), audioContext.currentTime); // volume increases
        gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.15);
        osc.start();
        osc.stop(audioContext.currentTime + 0.15);
    }
    
    function playCassetteInsert() {
        // Mechanical click
        const click = audioContext.createOscillator();
        const clickGain = audioContext.createGain();
        click.connect(clickGain);
        clickGain.connect(audioContext.destination);
        click.frequency.value = 200;
        clickGain.gain.setValueAtTime(0.15, audioContext.currentTime);
        clickGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        click.start();
        click.stop(audioContext.currentTime + 0.1);
        
        // Tape head engage (whirr)
        setTimeout(() => {
            const whirr = audioContext.createOscillator();
            const whirrGain = audioContext.createGain();
            whirr.connect(whirrGain);
            whirrGain.connect(audioContext.destination);
            whirr.type = 'sawtooth';
            whirr.frequency.setValueAtTime(100, audioContext.currentTime);
            whirr.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.3);
            whirrGain.gain.setValueAtTime(0.08, audioContext.currentTime);
            whirrGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            whirr.start();
            whirr.stop(audioContext.currentTime + 0.3);
        }, 100);
    }
    
    function playSuccess() {
        [400, 600, 800].forEach((freq, i) => {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                osc.start();
                osc.stop(audioContext.currentTime + 0.15);
            }, i * 50);
        });
    }
    
    function playError() {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.setValueAtTime(600, audioContext.currentTime);
        osc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);
        gain.gain.setValueAtTime(0.15, audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        osc.start();
        osc.stop(audioContext.currentTime + 0.2);
    }
    
    function playCelebration() {
        // Triumphant ascending fanfare
        const notes = [392, 494, 587, 698, 784, 880]; // G, B, D, F, G, A
        notes.forEach((freq, i) => {
            setTimeout(() => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                osc.type = 'sine';
                gain.gain.setValueAtTime(0.12, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                osc.start();
                osc.stop(audioContext.currentTime + 0.4);
            }, i * 80);
        });
    }

    // Game Variables
    const SET_LIMIT = 10;
    const TASK_TIME = 30; 
    const cardDecks = {
        production: [
            'Add reverb to vocals', 'Pan drums left and right', 'Add a hi-pass filter', 'Boost the bass frequencies',
            'Cut harsh high frequencies', 'Add compression to vocals', 'Layer a pad sound', 'Add delay to lead',
            'Boost the kick drum', 'Add distortion to bass', 'Pan the hi-hats right', 'Add a low-pass filter',
            'Boost 1kHz on vocals', 'Add sidechain compression', 'Layer two kick drums', 'Add stereo width',
            'Cut 200Hz muddiness', 'Boost treble on snare', 'Add a sub bass layer', 'Pan guitar left',
            'Add tape saturation', 'Boost presence at 3kHz', 'Add a gate to drums', 'Layer vocal harmonies',
            'Cut boxiness at 500Hz', 'Add chorus to keys', 'Boost air at 10kHz', 'Pan synth right',
            'Add parallel compression', 'Cut low end rumble', 'Boost attack on drums', 'Add a stereo imager',
            'Layer ambient noise', 'Pan claps center', 'Add saturation to vocals', 'Boost warmth at 200Hz',
            'Cut harshness at 4kHz', 'Add a limiter', 'Layer string sounds', 'Pan percussion wide',
            'Add tube warmth', 'Boost clarity at 5kHz', 'Cut sibilance at 8kHz', 'Layer bass synth',
            'Pan lead vocal center', 'Add glue compression', 'Boost punch at 100Hz', 'Cut nasal at 1kHz',
            'Layer background vocals', 'Pan effects left', 'Add analog warmth', 'Boost shine at 12kHz',
            'Cut mid-range mud', 'Add vocal doubling', 'Layer acoustic guitar', 'Pan string section wide',
            'Add vintage compression', 'Boost low mids', 'Cut digital harshness', 'Layer electric piano',
            'Pan shaker right', 'Add console emulation', 'Boost sub frequencies', 'Cut resonance peaks',
            'Layer brass section', 'Pan tambourine left', 'Add tape delay', 'Boost upper mids',
            'Cut room resonance', 'Layer synth pad', 'Pan ride cymbal right', 'Add spring reverb',
            'Boost vocal presence', 'Cut proximity effect', 'Layer orchestral hits', 'Pan toms across stereo',
            'Add plate reverb', 'Boost drum transients', 'Cut phase issues', 'Layer choir sounds'
        ],
        songwriting: [
            'Write about the weather', 'Use the word "fire"', 'Rhyme the last word', 'Describe a color',
            'Write about time', 'Use a metaphor', 'Mention a city', 'Write about water',
            'Use alliteration', 'Write about night', 'Mention an emotion', 'Use repetition',
            'Write about movement', 'Describe a texture', 'Use a simile', 'Write about light',
            'Mention a season', 'Write about silence', 'Use contrast', 'Write about sky',
            'Describe a feeling', 'Use personification', 'Write about speed', 'Mention darkness',
            'Write about distance', 'Use the word heart', 'Write about memories', 'Describe a sound',
            'Use imagery', 'Write about hope', 'Mention the moon', 'Write about change',
            'Use the word soul', 'Write about journey', 'Describe a moment', 'Use rhythm',
            'Write about freedom', 'Mention the sun', 'Write about truth', 'Use the word dream',
            'Write about tomorrow', 'Describe a touch', 'Use parallelism', 'Write about home',
            'Mention a number', 'Write about breaking', 'Use the word eyes', 'Write about forever',
            'Describe a taste', 'Use contradiction', 'Write about rising', 'Mention a direction',
            'Write about falling', 'Use the word love', 'Write about yesterday', 'Describe a smell',
            'Use anaphora', 'Write about hiding', 'Mention the stars', 'Write about searching',
            'Use the word shadows', 'Write about running', 'Describe temperature', 'Use hyperbole',
            'Write about waiting', 'Mention the ocean', 'Write about leaving', 'Use the word tears',
            'Write about finding', 'Describe a place', 'Use juxtaposition', 'Write about wanting',
            'Mention the wind', 'Write about staying', 'Use the word hands', 'Write about believing',
            'Describe a person', 'Use epistrophe', 'Write about losing', 'Mention a flower'
        ],
        beats: [
            'Change kick drum sound', 'Speed up the hi-hats', 'Add a clap sound', 'Slow down tempo',
            'Change snare pitch', 'Add a shaker', 'Make drums louder', 'Add a ride cymbal',
            'Change hi-hat pattern', 'Add tom fills', 'Make kick punchier', 'Add a crash',
            'Change snare pattern', 'Add percussion loop', 'Make hi-hats softer', 'Add cowbell',
            'Swing the rhythm', 'Add rim shots', 'Make drums tighter', 'Add a tambourine',
            'Change drum spacing', 'Add finger snaps', 'Make kick deeper', 'Add wood blocks',
            'Shuffle the groove', 'Add hand claps', 'Make snare crisper', 'Add a bell',
            'Change drum speed', 'Add bongo hits', 'Make hi-hats open', 'Add triangle',
            'Quantize the drums', 'Add conga drums', 'Make kick faster', 'Add sleigh bells',
            'Humanize timing', 'Add tabla sounds', 'Make snare deeper', 'Add chimes',
            'Add drum rolls', 'Add djembe hits', 'Make hi-hats closed', 'Add maracas',
            'Layer kick drums', 'Add wood block', 'Make drums drier', 'Add gÃ¼iro',
            'Add ghost notes', 'Add clave pattern', 'Make snare tighter', 'Add vibraslap',
            'Change drum tone', 'Add cabasa', 'Make kick tighter', 'Add agogo bells',
            'Add drum break', 'Add cajÃ³n sound', 'Make hi-hats louder', 'Add wind chimes',
            'Reverse a cymbal', 'Add timbales', 'Make snare shorter', 'Add cuica',
            'Add triplet hi-hats', 'Add surdo drum', 'Make kick shorter', 'Add berimbau',
            'Add syncopation', 'Add pandeiro', 'Make drums roomy', 'Add reco-reco',
            'Add half-time feel', 'Add repinique', 'Make snare longer', 'Add triangle roll',
            'Add double-time feel', 'Add tamborim', 'Make kick longer', 'Add gÃ¼ira scrape'
        ]
    };

    let sessionClout = 0, timeLeft = 0, timerInterval = null, selectedMode = '', tasksCompleted = 0, currentCallsign = "";
    let comboCount = 0, rerunUsedInSession = false, cleanStreakCount = 0, cooldownLeft = 0, speedDemonCount = 0;
    let usedCards = [];

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
        if(id === 'screen-modes') { 
            updateRankDisplay(); 
            renderBadges();
            updateStreak();
        }
        playClick();
    }

    function renderBadges() {
        const count = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
        const container = document.getElementById('badge-container');
        container.innerHTML = '';
        for(let i=0; i<count; i++) {
            const b = document.createElement('div');
            b.className = 'mini-badge';
            container.appendChild(b);
        }
    }

    async function updateRankDisplay() {
        const savedClout = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        const personalBest = parseInt(localStorage.getItem(`best_${currentCallsign}`) || 0);
        
        document.getElementById('global-rank-display').innerText = personalBest;
        document.getElementById('last-score').innerText = `${savedClout} LIFETIME CLOUT`;
    }
    
    function updateStreak() {
        const today = new Date().toDateString();
        const lastPlayed = localStorage.getItem(`lastPlayed_${currentCallsign}`);
        let currentStreak = parseInt(localStorage.getItem(`streak_${currentCallsign}`) || 0);
        
        if (lastPlayed) {
            const lastDate = new Date(lastPlayed);
            const todayDate = new Date(today);
            const diffTime = todayDate - lastDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                // Already played today, keep streak
            } else if (diffDays === 1) {
                // Consecutive day, increment streak
                currentStreak++;
                localStorage.setItem(`streak_${currentCallsign}`, currentStreak);
                localStorage.setItem(`lastPlayed_${currentCallsign}`, today);
            } else {
                // Streak broken, reset to 0
                currentStreak = 0;
                localStorage.setItem(`streak_${currentCallsign}`, currentStreak);
                localStorage.setItem(`lastPlayed_${currentCallsign}`, today);
            }
        } else {
            // First time playing
            currentStreak = 0;
            localStorage.setItem(`lastPlayed_${currentCallsign}`, today);
        }
        
        document.getElementById('streak-count').innerText = currentStreak;
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if(name.length < 2) return;
        currentCallsign = name;
        document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
        playSuccess();
        if(!sessionStorage.getItem('manualSeen')) {
            sessionStorage.setItem('manualSeen', 'true');
            showScreen('screen-manual');
        } else { showScreen('screen-modes'); }
    }

    function startGame(mode) {
        selectedMode = mode; 
        tasksCompleted = 0; 
        sessionClout = 0;
        comboCount = 0; 
        cleanStreakCount = 0; 
        rerunUsedInSession = false; 
        speedDemonCount = 0;
        usedCards = [];
        document.getElementById('clout-val').innerText = "0";
        document.getElementById('perfect-badge').style.display = "none";
        playSuccess();
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if(tasksCompleted >= SET_LIMIT) { endSession(); return; }
        
        document.getElementById('task-count').innerText = `${tasksCompleted + 1}/${SET_LIMIT}`;
        
        const deck = cardDecks[selectedMode] || cardDecks.production;
        let availableCards = deck.filter(card => !usedCards.includes(card));
        
        if (availableCards.length === 0) {
            usedCards = [];
            availableCards = [...deck];
        }
        
        const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
        usedCards.push(randomCard);
        
        const cardBody = document.getElementById('card-body');
        cardBody.classList.add('cassette-load');
        cardBody.innerText = randomCard;
        
        playCassetteInsert();
        
        setTimeout(() => cardBody.classList.remove('cassette-load'), 600);
        
        timeLeft = TASK_TIME;
        cooldownLeft = 10; 
        updateCooldownUI();
        startTimer();
    }

    function updateCooldownUI() {
        const btn = document.getElementById('complete-btn');
        const timerTxt = document.getElementById('cooldown-timer');
        if (cooldownLeft > 0) {
            btn.classList.add('btn-locked');
            timerTxt.innerText = `LOCKED: ${cooldownLeft}s`;
        } else {
            btn.classList.remove('btn-locked');
            timerTxt.innerText = "READY";
        }
    }

    function startTimer() {
        clearInterval(timerInterval);
        const timerEl = document.getElementById('timer');
        timerEl.classList.remove('timer-low');
        timerInterval = setInterval(() => {
            timeLeft--;
            if(cooldownLeft > 0) { cooldownLeft--; updateCooldownUI(); }
            if(timeLeft <= 10) {
                timerEl.classList.add('timer-low');
                // Alarm buzz with increasing intensity
                const intensity = (10 - timeLeft) / 10; // 0 at 10s, 1 at 0s
                playAlarmBuzz(intensity);
            } else {
                // Subtle tick sound
                playTick();
            }
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            timerEl.innerText = (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);
            if(timeLeft <= 0) { 
                clearInterval(timerInterval); 
                comboCount = 0; 
                playError();
                showScreen('screen-modes'); 
            }
        }, 1000);
    }

    function attemptComplete() {
        if(cooldownLeft > 0) { showCheatError(); return; }
        completeTask();
    }

    function showCheatError() {
        const err = document.getElementById('cheat-error');
        err.style.opacity = "1";
        playError();
        setTimeout(() => err.style.opacity = "0", 2000);
    }

    function completeTask() {
        let currentBonus = 0;
        if (timeLeft > 15) { 
            currentBonus += 5; 
            speedDemonCount++; 
            triggerAlert("SPEED DEMON +5"); 
        }
        tasksCompleted++; 
        sessionClout += (10 + currentBonus);
        comboCount++; 
        cleanStreakCount++;
        
        playSuccess();
        
        if(comboCount === 3) { 
            sessionClout += 25; 
            setTimeout(() => triggerAlert("XP OVERDRIVE +25"), 800); 
            comboCount = 0; 
        }
        if(cleanStreakCount === 6 && !rerunUsedInSession) {
            const bonus = Math.floor(Math.random() * 101) + 50; 
            sessionClout += bonus;
            setTimeout(() => triggerAlert(`CLEAN STREAK +${bonus}`), 1600);
        }
        document.getElementById('clout-val').innerText = sessionClout;
        drawTask();
    }

    function triggerAlert(text) {
        const alert = document.getElementById('combo-alert');
        alert.innerText = text; 
        alert.style.opacity = "1";
        setTimeout(() => alert.style.opacity = "0", 2000);
    }

    function rerollTask() { 
        rerunUsedInSession = true; 
        cleanStreakCount = 0; 
        
        // Deduct 5 clout for using rerun (can go negative)
        sessionClout -= 5;
        document.getElementById('clout-val').innerText = sessionClout;
        
        playClick();
        
        const deck = cardDecks[selectedMode] || cardDecks.production;
        let availableCards = deck.filter(card => !usedCards.includes(card));
        
        if (availableCards.length === 0) {
            availableCards = [...deck];
        }
        
        const randomCard = availableCards[Math.floor(Math.random() * availableCards.length)];
        const lastCard = usedCards[usedCards.length - 1];
        usedCards[usedCards.length - 1] = randomCard;
        
        const cardBody = document.getElementById('card-body');
        cardBody.classList.add('cassette-load');
        cardBody.innerText = randomCard;
        playCassetteInsert();
        setTimeout(() => cardBody.classList.remove('cassette-load'), 600);
        
        // Reset timer and cooldown
        timeLeft = TASK_TIME;
        cooldownLeft = 10;
        updateCooldownUI();
        startTimer();
    }

    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        
        // Update last played date when completing a session
        const today = new Date().toDateString();
        const lastPlayed = localStorage.getItem(`lastPlayed_${currentCallsign}`);
        
        if (lastPlayed !== today) {
            const lastDate = new Date(lastPlayed || today);
            const todayDate = new Date(today);
            const diffTime = todayDate - lastDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let currentStreak = parseInt(localStorage.getItem(`streak_${currentCallsign}`) || 0);
            
            if (diffDays === 1) {
                // Consecutive day
                currentStreak++;
            } else if (diffDays > 1) {
                // Streak broken
                currentStreak = 1;
            } else {
                // Same day, don't change
                currentStreak = currentStreak || 1;
            }
            
            localStorage.setItem(`streak_${currentCallsign}`, currentStreak);
            localStorage.setItem(`lastPlayed_${currentCallsign}`, today);
        }
        
        // Play celebration fanfare
        playCelebration();
        
        if (!rerunUsedInSession && speedDemonCount >= 5) {
            document.getElementById('perfect-badge').style.display = "block";
            sessionClout += 100;
            const perfects = parseInt(localStorage.getItem(`perfect_${currentCallsign}`) || 0);
            localStorage.setItem(`perfect_${currentCallsign}`, perfects + 1);
        }

        // Update lifetime clout
        const currentTotal = parseInt(localStorage.getItem(`clout_${currentCallsign}`) || 0);
        localStorage.setItem(`clout_${currentCallsign}`, currentTotal + sessionClout);
        
        // Update personal best if this session beat it
        const currentBest = parseInt(localStorage.getItem(`best_${currentCallsign}`) || 0);
        if (sessionClout > currentBest) {
            localStorage.setItem(`best_${currentCallsign}`, sessionClout);
            document.getElementById('result-header').innerText = "NEW PERSONAL BEST!";
        } else {
            document.getElementById('result-header').innerText = "SET COMPLETE";
        }
        
        document.getElementById('result-clout').innerText = sessionClout;
        document.getElementById('result-footer').innerText = "SESSION ARCHIVED TO LOCAL RIG.";
    }

    function resetAll() { 
        if(confirm("ERASE ALL CAREER PROGRESS AND LOGOUT?")) { 
            localStorage.clear();
            sessionStorage.clear();
            currentCallsign = "";
            playError();
            document.getElementById('username').value = '';
            document.getElementById('welcome-msg').innerText = 'WELCOME, ARTIST';
            document.getElementById('global-rank-display').innerText = '0';
            document.getElementById('last-score').innerText = '0 LIFETIME CLOUT';
            document.getElementById('badge-container').innerHTML = '';
            showScreen('screen-auth');
        } 
    }
    
    function restartSession() {
        if(confirm("RESTART THIS SESSION? (Progress will be lost)")) {
            playClick();
            startGame(selectedMode);
        }
    }
    
    function exitGame() { 
        clearInterval(timerInterval); 
        playClick();
        showScreen('screen-modes'); 
    }
    
    window.onload = () => showScreen('screen-auth');
</script>
</body>
</html>
