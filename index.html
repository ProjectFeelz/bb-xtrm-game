-- =====================================================
-- COMMUNITY FEED TABLES & FUNCTIONS
-- =====================================================

-- Add challenge_id to feed_posts to link submissions to challenges
ALTER TABLE feed_posts ADD COLUMN IF NOT EXISTS challenge_id UUID REFERENCES weekly_challenges(id);
ALTER TABLE feed_posts ADD COLUMN IF NOT EXISTS is_challenge_entry BOOLEAN DEFAULT false;

-- Create comments table
CREATE TABLE IF NOT EXISTS feed_comments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    post_id UUID REFERENCES feed_posts(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id),
    artist_name TEXT NOT NULL,
    comment_text TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS on comments
ALTER TABLE feed_comments ENABLE ROW LEVEL SECURITY;

-- Policies for comments
DROP POLICY IF EXISTS "Anyone can view comments" ON feed_comments;
CREATE POLICY "Anyone can view comments" ON feed_comments
FOR SELECT USING (true);

DROP POLICY IF EXISTS "Users can insert own comments" ON feed_comments;
CREATE POLICY "Users can insert own comments" ON feed_comments
FOR INSERT WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can delete own comments" ON feed_comments;
CREATE POLICY "Users can delete own comments" ON feed_comments
FOR DELETE USING (auth.uid() = user_id);

-- Add winner fields to weekly_challenges
ALTER TABLE weekly_challenges ADD COLUMN IF NOT EXISTS winner_post_id UUID REFERENCES feed_posts(id);
ALTER TABLE weekly_challenges ADD COLUMN IF NOT EXISTS winner_announced BOOLEAN DEFAULT false;
ALTER TABLE weekly_challenges ADD COLUMN IF NOT EXISTS youtube_live_url TEXT;

-- Function to submit a challenge entry
CREATE OR REPLACE FUNCTION submit_challenge_entry(
    p_tiktok_url TEXT,
    p_description TEXT DEFAULT NULL
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_id UUID;
    v_artist_name TEXT;
    v_challenge_id UUID;
    v_card_text TEXT;
BEGIN
    v_user_id := auth.uid();
    
    IF v_user_id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'Not authenticated');
    END IF;
    
    SELECT artist_name INTO v_artist_name FROM profiles WHERE id = v_user_id;
    
    SELECT id, card_text INTO v_challenge_id, v_card_text 
    FROM weekly_challenges 
    WHERE is_active = true 
    AND CURRENT_DATE BETWEEN start_date AND end_date
    LIMIT 1;
    
    IF v_challenge_id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'No active challenge');
    END IF;
    
    INSERT INTO feed_posts (user_id, artist_name, tiktok_url, card_text, game_mode, description, is_challenge_entry, challenge_id, is_approved)
    VALUES (v_user_id, v_artist_name, p_tiktok_url, v_card_text, 'challenge', p_description, true, v_challenge_id, true);
    
    RETURN json_build_object('success', true, 'message', 'Challenge entry submitted!');
END;
$$;

-- Function to add a comment
CREATE OR REPLACE FUNCTION add_comment(p_post_id UUID, p_comment_text TEXT)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_id UUID;
    v_artist_name TEXT;
BEGIN
    v_user_id := auth.uid();
    
    IF v_user_id IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'Not authenticated');
    END IF;
    
    SELECT artist_name INTO v_artist_name FROM profiles WHERE id = v_user_id;
    
    INSERT INTO feed_comments (post_id, user_id, artist_name, comment_text)
    VALUES (p_post_id, v_user_id, v_artist_name, p_comment_text);
    
    RETURN json_build_object('success', true);
END;
$$;
