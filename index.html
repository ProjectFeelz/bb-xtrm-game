<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO</title>
    <link rel="icon" href="data:,">
    <style>
        :root {
            --bg: #0a0b0e; --panel: #161a1f; --border: #2a2f36;
            --cyan: #00f2ff; --magenta: #ff00ff; --yellow: #f1c40f;
            --green: #2ecc71; --red: #ff4757;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Courier New', monospace; }
        body {
            background-color: var(--bg); color: #e0e0e0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: radial-gradient(circle at center, #1a1d23 0%, #0a0b0e 100%);
        }
        body::before {
            content: " "; display: block; position: absolute; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
            z-index: 500; background-size: 100% 4px, 3px 100%; pointer-events: none;
        }
        #console {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background: var(--panel); border: 2px solid var(--border);
            border-radius: 20px; position: relative; overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; inset: 0; padding: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: var(--panel); z-index: 10;
        }
        .active-screen { display: flex; }
        .logo-small { font-size: 2rem; font-weight: 900; color: var(--cyan); margin-bottom: 20px; font-style: italic; }
        .logo-big { font-size: 4.5rem; font-weight: 900; color: var(--cyan); line-height: 0.9; text-align: center; margin-bottom: 10px; font-style: italic; }
        h2 { font-size: 0.7rem; letter-spacing: 3px; color: #666; text-transform: uppercase; margin-bottom: 25px; text-align: center; }
        .rule-card { width: 100%; background: rgba(0,0,0,0.3); padding: 18px; border-left: 3px solid var(--cyan); margin-bottom: 12px; }
        .rule-card h3 { font-size: 0.75rem; color: var(--cyan); margin-bottom: 4px; letter-spacing: 1px; }
        .rule-card p { font-size: 0.8rem; color: #bbb; line-height: 1.4; }
        input {
            width: 100%; padding: 16px; background: #0a0b0e; border: 1px solid var(--border);
            color: var(--cyan); border-radius: 8px; outline: none; font-size: 1.1rem; text-align: center;
        }
        .btn {
            width: 100%; padding: 18px; border: 1px solid var(--border); border-radius: 12px;
            background: rgba(255,255,255,0.03); color: white; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--cyan); color: black; border: none; }
        #timer { font-size: 6.5rem; font-weight: 200; color: var(--yellow); font-family: 'Courier New', monospace; margin: 10px 0; }
        #card { width: 100%; flex: 1; min-height: 200px; border: 2px solid var(--border); background: #121519; border-radius: 15px; display: flex; flex-direction: column; margin: 15px 0; }
        #card-body-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; }
        #card-body { font-size: 1.2rem; font-weight: 500; line-height: 1.5; color: var(--cyan); margin-bottom: 20px; }
        #combo-container { text-align: center; transform: skewX(-5deg); display: none; }
        #combo-value { font-size: 3.5rem; font-weight: 900; color: var(--magenta); text-shadow: 0 0 20px var(--magenta); line-height: 1; font-style: italic; }
        #combo-label { font-size: 0.7rem; color: white; letter-spacing: 2px; margin-top: 5px; opacity: 0.8; }
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding: 20px; background: rgba(0,0,0,0.4); }
        .btn-game { font-size: 0.7rem; padding: 12px; color: #888; border-color: #333; }
        #progress-bar { width: 100%; height: 4px; background: #222; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: var(--cyan); transition: 0.3s; }
        .results-card { background: #121519; border: 1px solid var(--border); border-radius: 15px; padding: 30px; width: 100%; text-align: center; }
        .clout-total { font-size: 3rem; color: var(--yellow); font-weight: 900; margin: 10px 0; }
        .status-msg { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <h2>Musician Registry</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" style="margin-top:20px" onclick="validateAuth()">LOGIN TO RIG</button>
    </div>

    <div id="screen-rules" class="screen">
        <div class="logo-small" style="color:var(--yellow); font-size:1.2rem;">OPERATIONAL PROTOCOL</div>
        <div class="rule-card"><h3>01. THE SET LIST</h3><p>Complete 10 tasks to finish a session and bank your clout.</p></div>
        <div class="rule-card" style="border-color: var(--magenta);"><h3>02. CLOUT & COMBOS</h3><p>Build streaks to multiply your Clout earnings.</p></div>
        <div class="rule-card" style="border-color: var(--yellow);"><h3>03. RISK MITIGATION</h3><p>Use Clout to Skip (-10) or Reroll (-5) the card and timer.</p></div>
        <button class="btn btn-primary" onclick="showScreen('screen-modes')">INITIATE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <div class="logo-big">BB<br>XTRM</div>
        <h2 id="welcome-msg">SELECT WORKFLOW</h2>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--cyan)" onclick="startGame('production')">ENGINEER / MIX</button>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--green)" onclick="startGame('beats')">BEAT MAKER / SAMPLER</button>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--magenta)" onclick="startGame('songwriting')">LYRICIST / WRITER</button>
        <button class="btn" style="margin-bottom:20px; border-left: 5px solid var(--yellow)" onclick="startGame('xtrm')">XTRM RANDOM</button>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn btn-game" style="flex:1" onclick="showLeaderboard()">RANKINGS</button>
            <button class="btn btn-game" style="flex:1" onclick="resetRig()">RESET RIG</button>
        </div>
    </div>

    <div id="screen-game" class="screen" style="padding:0; justify-content: flex-start;">
        <header style="width:100%; padding: 20px; display:flex; justify-content:space-between; font-size:0.75rem; border-bottom:1px solid var(--border); background: rgba(0,0,0,0.3);">
            <div id="user-tag" style="font-weight:bold; color:var(--cyan)">MUSICIAN: ---</div>
            <div id="task-counter" style="color:#666">SET: 1/10</div>
            <div id="clout-display" style="color:var(--yellow)">CLOUT: 0</div>
        </header>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="game-main" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; padding:25px;">
            <div id="timer">00:00</div>
            <div id="card">
                <div id="card-header" style="font-size:0.6rem; letter-spacing:4px; padding:10px; text-align:center; color:#444; border-bottom:1px solid #222;">SYSTEM_PROMPT</div>
                <div id="card-body-wrapper">
                    <div id="card-body">Awaiting sync...</div>
                    <div id="combo-container">
                        <div id="combo-value">x1.0</div>
                        <div id="combo-label">COMBO ACTIVE</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="game-controls">
            <button class="btn btn-primary" style="grid-column: span 2;" onclick="completeTask()">TASK COMPLETE</button>
            <button class="btn btn-game" onclick="skipCard()">SKIP (-10)</button>
            <button class="btn btn-game" onclick="rerollTimer()">REROLL (-5)</button>
            <button class="btn btn-game" onclick="togglePause()" id="pause-btn">PAUSE</button>
            <button class="btn btn-game" style="color:var(--red)" onclick="exitGame()">EJECT</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <div class="logo-small" id="result-header">SET COMPLETE!</div>
        <div class="results-card">
            <p id="result-artist" style="color:var(--cyan); font-weight:bold; margin-bottom:10px;">ARTIST: ---</p>
            <p class="status-msg">Clout Banked</p>
            <div class="clout-total" id="result-clout">0</div>
            <p class="status-msg" id="result-footer">The rig is cooling down.</p>
        </div>
        <button class="btn btn-primary" style="margin-top:30px" onclick="showScreen('screen-modes')">RETURN TO HUB</button>
    </div>

    <div id="screen-board" class="screen">
        <h2>Global Rankings</h2>
        <div style="width:100%; overflow-y: auto; max-height: 400px;">
            <table style="width:100%; margin-top:10px;"><tbody id="leaderboard-body"></tbody></table>
        </div>
        <button class="btn btn-primary" style="margin-top:40px" onclick="showScreen('screen-modes')">RETURN TO RIG</button>
    </div>
</div>

<script>
    // --- DATA ---
    const SET_LIMIT = 10;
    const paceDecks = [30, 45, 60, 90, 120];
    const cardDecks = {
        production: ['Filter everything below 200Hz', 'Layer a snare sample', 'Bus melodic elements', 'Mute lead instrument', 'Apply 1/8th delay'],
        songwriting: ['Rhyme with Stone', 'No I, Me, or My', '3 consecutive questions', 'Start with previous word'],
        beats: ['Replace snare with Clap', 'Nudge hi-hats late', 'Pitch kick up 3 semitones', '1-bar drum break']
    };

    // --- STATE ---
    let clout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', currentType = '', tasksCompleted = 0;
    let combo = 0, multiplier = 1.0, currentCallsign = "";
    const API_PATH = "/.netlify/functions";

    // --- CORE FUNCTIONS ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if (name.length < 2) return alert("IDENTIFICATION REQUIRED");
        currentCallsign = name;
        localStorage.setItem('bb_artist_name', name);
        showScreen('screen-rules');
    }

    function startGame(mode) {
        selectedMode = mode;
        tasksCompleted = 0;
        clout = 0;
        combo = 0;
        multiplier = 1.0;
        document.getElementById('user-tag').innerText = `MUSICIAN: ${currentCallsign}`;
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if (tasksCompleted >= SET_LIMIT) { endSession(); return; }
        isPaused = false;
        document.getElementById('pause-btn').innerText = "PAUSE";
        const seconds = paceDecks[Math.floor(Math.random() * paceDecks.length)];
        startTimer(seconds);
        currentType = selectedMode === 'xtrm' ? ['production', 'songwriting', 'beats'][Math.floor(Math.random() * 3)] : selectedMode;
        const deck = cardDecks[currentType];
        document.getElementById('card-body').innerText = deck[Math.floor(Math.random() * deck.length)];
        document.getElementById('card-body').style.color = { production: 'var(--cyan)', songwriting: 'var(--magenta)', beats: 'var(--green)' }[currentType];
        updateSessionUI();
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        timeLeft = seconds;
        updateUI();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeLeft--; updateUI();
                if (timeLeft <= 0) breakCombo();
            }
        }, 1000);
    }

    function updateUI() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        const el = document.getElementById('timer');
        el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        el.style.color = timeLeft < 10 ? 'var(--red)' : 'var(--yellow)';
        document.getElementById('clout-display').innerText = `CLOUT: ${clout}`;
        document.getElementById('combo-container').style.display = combo >= 3 ? 'block' : 'none';
        document.getElementById('combo-value').innerText = `x${multiplier.toFixed(1)}`;
    }

    function updateSessionUI() {
        document.getElementById('task-counter').innerText = `SET: ${tasksCompleted + 1}/${SET_LIMIT}`;
        document.getElementById('progress-fill').style.width = `${(tasksCompleted / SET_LIMIT) * 100}%`;
    }

    function completeTask() {
        tasksCompleted++;
        combo++;
        multiplier = 1.0 + Math.floor(combo / 3) * 0.5; 
        clout += Math.floor(10 * multiplier);
        drawTask();
    }

    function breakCombo() {
        clearInterval(timerInterval);
        combo = 0; multiplier = 1.0;
        document.getElementById('result-header').innerText = "SYSTEM FAILURE";
        document.getElementById('result-header').style.color = "var(--red)";
        document.getElementById('result-clout').innerText = "COMBO RESET";
        showScreen('screen-results');
    }

    // --- API SYNC FUNCTIONS ---
    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        document.getElementById('result-artist').innerText = `ARTIST: ${currentCallsign}`;
        document.getElementById('result-clout').innerText = clout;
        document.getElementById('result-footer').innerText = "SYNCING TO GLOBAL RIG...";
        
        try {
            await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                body: JSON.stringify({ username: currentCallsign, score: clout })
            });
            document.getElementById('result-footer').innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { document.getElementById('result-footer').innerText = "LOCAL SAVE ONLY."; }
    }

    async function showLeaderboard() {
        const body = document.getElementById('leaderboard-body');
        body.innerHTML = '<tr><td>FETCHING...</td></tr>';
        showScreen('screen-board');
        try {
            const res = await fetch(`${API_PATH}/get-scores`);
            const data = await res.json();
            body.innerHTML = data.map((d, i) => `<tr><td style="padding:10px 0; border-bottom:1px solid #222;"><span style="color:var(--yellow)">#${i+1}</span> ${d.username}</td><td style="text-align:right">${d.clout}</td></tr>`).join('');
        } catch (e) { body.innerHTML = '<tr><td>CONNECTION ERROR</td></tr>'; }
    }

    // --- UTILS ---
    function skipCard() { if(clout >= 10) { clout -= 10; combo = 0; multiplier = 1.0; drawTask(); } }
    function rerollTimer() { if(clout >= 5) { clout -= 5; drawTask(); } }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { if(confirm("Eject?")) { clearInterval(timerInterval); showScreen('screen-modes'); } }
    function resetRig() { if(confirm("Wipe data?")) { localStorage.clear(); location.reload(); } }

    // --- INITIALIZE ---
    window.onload = () => {
        const saved = localStorage.getItem('bb_artist_name');
        if (saved) {
            currentCallsign = saved;
            document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
            showScreen('screen-modes');
        } else {
            showScreen('screen-auth');
        }
    };
</script>
</body>
</html>
