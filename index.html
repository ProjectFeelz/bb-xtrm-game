<script>
    // --- MASSIVE DATA DECKS (90+ UNIQUE TASKS) ---
    const SET_LIMIT = 10;
    const paceDecks = [30, 45, 60, 90, 120];
    
    const cardDecks = {
        production: [
            'Turn down the volume on the loudest sound', 'Make the bass sound "thicker"', 'Add a tiny bit of echo to the lead melody', 'Make the drums sound like they are in a big room', 'Remove the very low sounds from the piano',
            'Make one sound move from the left ear to the right ear', 'Add a "fuzzy" or "crunchy" sound to the kick drum', 'Make the vocals sound like they are coming through a telephone', 'Turn off the loudest instrument for 10 seconds', 'Make the quietest sound much louder',
            'Add a "shimmer" effect to the high sounds', 'Make the song feel more "airy"', 'Slowly turn the volume up on a new sound', 'Make the drums sound "punchy" and sharp', 'Add a "wah-wah" effect to a sound',
            'Make a sound repeat every 4 beats', 'Turn down the high sounds on the bass', 'Make the snare drum sound "snappier"', 'Add a "ghost" sound that is very quiet', 'Make the song sound "darker" or "moodier"',
            'Add a "bright" sound to the chorus', 'Make the lead instrument sound "wide"', 'Add a "robotic" feel to a vocal', 'Make a sound "pulse" like a heartbeat', 'Turn off all the "echo" effects for a moment',
            'Make the kick drum feel like a "thump" in your chest', 'Add a "swirling" sound effect', 'Make the song sound like it is underwater', 'Add a "crackling" record player sound', 'Make the vocals sound very close to the listener',
            'Turn up the "mid" sounds on the guitar', 'Make a sound "glitch" or stutter', 'Add a "metallic" ring to a sound', 'Make the song sound "warm" like an old tape', 'Add a "hissing" sound in the background',
            'Make the drums sound "dry" and close', 'Add a "twinkling" sound at the end of a bar', 'Make a sound "fade away" slowly', 'Turn the bass up until you can feel it', 'Make the high-hats sound "silky"',
            'Add a "spacey" reverb to the synth', 'Make the song sound "aggressive"', 'Add a "pumping" effect to the music', 'Make a sound "vibrate" quickly', 'Turn the vocals down so they hide in the music',
            'Make the song sound "lo-fi"', 'Add a "shaking" sound to the rhythm', 'Make a sound feel "heavy"', 'Add a "whistling" sound', 'Make the music "dip" when the kick drum hits',
            'Turn up the treble on the bells', 'Make a sound feel "hollow"', 'Add a "pulsing" light sound', 'Make the song sound "royal"', 'Add a "nature" sound like rain',
            'Make a sound "jump" around the speakers', 'Add a "clock ticking" sound', 'Make the music feel "fast" even if it is slow', 'Add a "laser" sound effect', 'Make the song sound "dusty"',
            'Turn off the bass for a whole bar', 'Make the drums sound "crushed"', 'Add a "human" sound like a clap', 'Make a sound "sweep" up in pitch', 'Add a "robotic" hum',
            'Make the song sound "vintage"', 'Add a "dreamy" texture', 'Make a sound "bounce"', 'Add a "sharp" edge to the lead', 'Make the song sound "expensive"',
            'Turn the volume down on the drums only', 'Make a sound "wobble"', 'Add a "clicking" rhythm', 'Make the song feel "empty" for a moment', 'Add a "distorted" vocal',
            'Make a sound "ring" like a bell', 'Add a "ocean wave" sound', 'Make the song feel "crowded"', 'Add a "glittery" sound', 'Make a sound "pop"',
            'Turn up the "bass" on the vocals', 'Make a sound "slide" up', 'Add a "choppy" effect', 'Make the song feel "chilly"', 'Add a "fire crackle" sound',
            'Make a sound "growl"', 'Add a "magic" chime', 'Make the song feel "tough"', 'Add a "wind" sound', 'Make the music "stop" suddenly'
        ],
        beats: [
            'Change the snare drum to a hand clap', 'Add a extra kick drum hit', 'Make the hi-hats play twice as fast', 'Remove the drums for 4 beats', 'Make the kick drum sound much deeper',
            'Add a "shake" sound every beat', 'Make the snare drum sound "tinny"', 'Play a drum fill at the end of the bar', 'Make the hi-hats sound "crunchy"', 'Add a "cowbell" sound',
            'Make the drums "swing" like a dance', 'Add a "tambourine" on the 2 and 4', 'Make the kick drum "slide" down', 'Remove the snare for a whole bar', 'Add a "rimshot" sound',
            'Make the drums sound "glitchy"', 'Add a "woodblock" hit', 'Make the hi-hats "open" and "close"', 'Add a "bongo" drum rhythm', 'Make the drums sound like they are in a cave',
            'Add a "stomp" sound', 'Make the kick drum play a "triplet"', 'Add a "snap" instead of a snare', 'Make the hi-hats "pan" left and right', 'Add a "crash" cymbal at the start',
            'Make the drums sound "old school"', 'Add a "shaker" that never stops', 'Make the kick drum very "short"', 'Add a "toms" drum roll', 'Make the drums sound "industrial"',
            'Add a "human" beatbox sound', 'Make the hi-hats sound "whispery"', 'Add a "reverse" cymbal sound', 'Make the drums feel "lazy" and slow', 'Add a "whistle" on the beat',
            'Make the kick drum sound "boxy"', 'Add a "triangle" ding', 'Make the snare sound "fat"', 'Add a "clink" sound like glass', 'Make the drums sound "futuristic"',
            'Add a "conga" drum loop', 'Make the hi-hats very "bright"', 'Add a "heartbeat" kick pattern', 'Make the drums "stop and start"', 'Add a "finger snap"',
            'Make the snare sound "wet" with echo', 'Add a "brush" drum sound', 'Make the kick "distorted"', 'Add a "sleigh bell" rhythm', 'Make the drums sound "lo-fi"',
            'Add a "gong" sound', 'Make the hi-hats "stutter"', 'Add a "knock" sound', 'Make the drums sound "muffled"', 'Add a "clapper" sound',
            'Make the kick drum "double up"', 'Add a "chime" on the 1', 'Make the snare "ring out"', 'Add a "scratchy" record sound', 'Make the drums "jumpy"',
            'Add a "pop" sound', 'Make the hi-hats "tick"', 'Add a "boom" sound', 'Make the drums "smooth"', 'Add a "clicking" beat',
            'Make the kick drum "soft"', 'Add a "buzz" sound', 'Make the snare "sharp"', 'Add a "ticking clock" drum', 'Make the drums "echo"',
            'Add a "rim click"', 'Make the hi-hats "fizz"', 'Add a "thud" sound', 'Make the drums "airy"', 'Add a "clap" on every beat',
            'Make the kick "punchy"', 'Add a "zip" sound', 'Make the snare "hollow"', 'Add a "shimmer" drum', 'Make the drums "heavy"',
            'Add a "bell" on the off-beat', 'Make the hi-hats "dark"', 'Add a "slap" sound', 'Make the drums "clean"', 'Add a "jingle"',
            'Make the kick "fast"', 'Add a "pulse" beat', 'Make the snare "loose"', 'Add a "rattle"', 'Make the drums "tight"'
        ],
        songwriting: [
            'Write a line that rhymes with "Blue"', 'Do not use the word "And" for two lines', 'Write a line that is a question', 'Use a word that starts with the letter "B"', 'Write about a "Rainy Day"',
            'Use the name of a fruit in a line', 'Write a line about "Time"', 'Use a word that rhymes with "Light"', 'Write a line about "Walking"', 'Use the word "Secret"',
            'Write a line about a "Friend"', 'Use a word that rhymes with "Play"', 'Write a line about "Home"', 'Use the word "Suddenly"', 'Write a line about a "Dream"',
            'Use a word that rhymes with "Gold"', 'Write a line about "Fire"', 'Use the word "Wait"', 'Write a line about "Music"', 'Use a word that rhymes with "Door"',
            'Write a line about the "Moon"', 'Use the word "Believe"', 'Write a line about "Flying"', 'Use a word that rhymes with "Heart"', 'Write a line about "Water"',
            'Use the word "Forever"', 'Write a line about "Changing"', 'Use a word that rhymes with "Star"', 'Write a line about "Lost"', 'Use the word "Found"',
            'Write a line about a "City"', 'Use a word that rhymes with "Street"', 'Write a line about "Morning"', 'Use the word "Never"', 'Write a line about "Shadows"',
            'Use a word that rhymes with "Sky"', 'Write a line about "Colors"', 'Use the word "Memory"', 'Write a line about "Bridges"', 'Use a word that rhymes with "Dance"',
            'Write a line about "Winter"', 'Use the word "Strong"', 'Write a line about "Flowers"', 'Use a word that rhymes with "Hand"', 'Write a line about "Silence"',
            'Use the word "Listen"', 'Write a line about "Mountain"', 'Use a word that rhymes with "Tree"', 'Write a line about "Gold"', 'Use the word "Silver"',
            'Write a line about "Running"', 'Use a word that rhymes with "Cold"', 'Write a line about "Summer"', 'Use the word "Hot"', 'Write a line about "Dust"',
            'Use a word that rhymes with "Wind"', 'Write a line about "Paper"', 'Use the word "Write"', 'Write a line about "Glass"', 'Use a word that rhymes with "Stone"',
            'Write a line about "Feathers"', 'Use the word "Soft"', 'Write a line about "Iron"', 'Use a word that rhymes with "Break"', 'Write a line about "Echo"',
            'Use the word "Voice"', 'Write a line about "Salt"', 'Use a word that rhymes with "Sea"', 'Write a line about "Clouds"', 'Use the word "Rain"',
            'Write a line about "Grass"', 'Use a word that rhymes with "Green"', 'Write a line about "Sun"', 'Use the word "Bright"', 'Write a line about "Road"',
            'Use a word that rhymes with "Miles"', 'Write a line about "Sleep"', 'Use the word "Quiet"', 'Write a line about "Storm"', 'Use a word that rhymes with "Dark"',
            'Write a line about "Light"', 'Use the word "Shadow"', 'Write a line about "Kings"', 'Use a word that rhymes with "Ring"', 'Write a line about "Wings"',
            'Use the word "High"', 'Write a line about "Deep"', 'Use a word that rhymes with "Sleep"', 'Write a line about "Fast"', 'Use a word that rhymes with "Last"'
        ]
    };

    // --- STATE ---
    let clout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', currentType = '', tasksCompleted = 0;
    let combo = 0, multiplier = 1.0, currentCallsign = "";
    let lastCard = ""; // Prevention for duplicate cards
    const API_PATH = "/.netlify/functions";

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if (name.length < 2) return alert("IDENTIFICATION REQUIRED");
        currentCallsign = name;
        localStorage.setItem('bb_artist_name', name);
        showScreen('screen-rules');
    }

    function startGame(mode) {
        selectedMode = mode;
        tasksCompleted = 0;
        clout = 0;
        combo = 0;
        multiplier = 1.0;
        document.getElementById('user-tag').innerText = `MUSICIAN: ${currentCallsign}`;
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if (tasksCompleted >= SET_LIMIT) { endSession(); return; }
        
        // CRITICAL FIX: Always clear the previous interval before starting a new one
        if (timerInterval) clearInterval(timerInterval);
        
        isPaused = false;
        document.getElementById('pause-btn').innerText = "PAUSE";
        
        const seconds = paceDecks[Math.floor(Math.random() * paceDecks.length)];
        
        currentType = selectedMode === 'xtrm' ? ['production', 'songwriting', 'beats'][Math.floor(Math.random() * 3)] : selectedMode;
        const deck = cardDecks[currentType];
        
        // CRITICAL FIX: Ensure the new card is different from the last card
        let newCard = deck[Math.floor(Math.random() * deck.length)];
        while (newCard === lastCard) {
            newCard = deck[Math.floor(Math.random() * deck.length)];
        }
        lastCard = newCard;

        document.getElementById('card-body').innerText = newCard;
        document.getElementById('card-body').style.color = { production: 'var(--cyan)', songwriting: 'var(--magenta)', beats: 'var(--green)' }[currentType];
        
        updateSessionUI();
        startTimer(seconds);
    }

    function startTimer(seconds) {
        timeLeft = seconds;
        updateUI();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeLeft--; 
                updateUI();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    breakCombo();
                }
            }
        }, 1000);
    }

    function updateUI() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        const el = document.getElementById('timer');
        el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        el.style.color = timeLeft < 10 ? 'var(--red)' : 'var(--yellow)';
        document.getElementById('clout-display').innerText = `CLOUT: ${clout}`;
        document.getElementById('combo-container').style.display = combo >= 3 ? 'block' : 'none';
        document.getElementById('combo-value').innerText = `x${multiplier.toFixed(1)}`;
    }

    function updateSessionUI() {
        document.getElementById('task-counter').innerText = `SET: ${tasksCompleted + 1}/${SET_LIMIT}`;
        document.getElementById('progress-fill').style.width = `${(tasksCompleted / SET_LIMIT) * 100}%`;
    }

    function completeTask() {
        tasksCompleted++;
        combo++;
        multiplier = 1.0 + (Math.floor(combo / 3) * 0.5); 
        clout += Math.floor(10 * multiplier);
        drawTask();
    }

    async function endSession() {
        if (timerInterval) clearInterval(timerInterval);
        showScreen('screen-results');
        document.getElementById('result-artist').innerText = `ARTIST: ${currentCallsign}`;
        document.getElementById('result-clout').innerText = clout;
        document.getElementById('result-footer').innerText = "SYNCING TO GLOBAL RIG...";
        
        try {
            const res = await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentCallsign, score: clout })
            });
            if (!res.ok) throw new Error("Sync Failed");
            document.getElementById('result-footer').innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { 
            document.getElementById('result-footer').innerText = "LOCAL SAVE ONLY. CHECK HUB CONNECTION."; 
        }
    }

    async function showLeaderboard() {
        const body = document.getElementById('leaderboard-body');
        body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">ACCESSING SATELLITE...</td></tr>';
        showScreen('screen-board');
        try {
            const res = await fetch(`${API_PATH}/get-scores`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            body.innerHTML = data.map((d, i) => `
                <tr>
                    <td style="padding:10px 0; border-bottom:1px solid #222;">
                        <span style="color:var(--yellow)">#${i+1}</span> ${d.username}
                    </td>
                    <td style="text-align:right; color:var(--cyan)">${d.clout}</td>
                </tr>`).join('');
        } catch (e) { 
            body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:var(--red);">CONNECTION ERROR: RIG OFFLINE</td></tr>'; 
        }
    }

    function skipCard() { if(clout >= 10) { clout -= 10; combo = 0; multiplier = 1.0; drawTask(); } }
    function rerollTimer() { if(clout >= 5) { clout -= 5; drawTask(); } }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { if(confirm("Eject?")) { clearInterval(timerInterval); showScreen('screen-modes'); } }
    function resetRig() { if(confirm("Wipe data?")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        const saved = localStorage.getItem('bb_artist_name');
        if (saved) {
            currentCallsign = saved;
            document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
            showScreen('screen-modes');
        } else {
            showScreen('screen-auth');
        }
    };
</script>
