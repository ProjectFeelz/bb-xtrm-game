<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BB XTRM // PRO STUDIO</title>
    <link rel="icon" href="data:,">
    <style>
        :root {
            --bg: #0a0b0e; --panel: #161a1f; --border: #2a2f36;
            --cyan: #00f2ff; --magenta: #ff00ff; --yellow: #f1c40f;
            --green: #2ecc71; --red: #ff4757;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Courier New', monospace; }
        body {
            background-color: var(--bg); color: #e0e0e0; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: radial-gradient(circle at center, #1a1d23 0%, #0a0b0e 100%);
        }
        body::before {
            content: " "; display: block; position: absolute; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
            z-index: 500; background-size: 100% 4px, 3px 100%; pointer-events: none;
        }
        #console {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background: var(--panel); border: 2px solid var(--border);
            border-radius: 20px; position: relative; overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; inset: 0; padding: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: var(--panel); z-index: 10;
        }
        .active-screen { display: flex; }
        .logo-small { font-size: 2rem; font-weight: 900; color: var(--cyan); margin-bottom: 20px; font-style: italic; }
        .logo-big { font-size: 4.5rem; font-weight: 900; color: var(--cyan); line-height: 0.9; text-align: center; margin-bottom: 10px; font-style: italic; }
        h2 { font-size: 0.7rem; letter-spacing: 3px; color: #666; text-transform: uppercase; margin-bottom: 25px; text-align: center; }
        .rule-card { width: 100%; background: rgba(0,0,0,0.3); padding: 18px; border-left: 3px solid var(--cyan); margin-bottom: 12px; }
        .rule-card h3 { font-size: 0.75rem; color: var(--cyan); margin-bottom: 4px; letter-spacing: 1px; }
        .rule-card p { font-size: 0.8rem; color: #bbb; line-height: 1.4; }
        input {
            width: 100%; padding: 16px; background: #0a0b0e; border: 1px solid var(--border);
            color: var(--cyan); border-radius: 8px; outline: none; font-size: 1.1rem; text-align: center;
        }
        .btn {
            width: 100%; padding: 18px; border: 1px solid var(--border); border-radius: 12px;
            background: rgba(255,255,255,0.03); color: white; font-weight: bold;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: 0.2s;
        }
        .btn-primary { background: var(--cyan); color: black; border: none; }
        #timer { font-size: 6.5rem; font-weight: 200; color: var(--yellow); font-family: 'Courier New', monospace; margin: 10px 0; }
        #card { width: 100%; flex: 1; min-height: 200px; border: 2px solid var(--border); background: #121519; border-radius: 15px; display: flex; flex-direction: column; margin: 15px 0; }
        #card-body-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; text-align: center; }
        #card-body { font-size: 1.2rem; font-weight: 500; line-height: 1.5; color: var(--cyan); margin-bottom: 20px; }
        #combo-container { text-align: center; transform: skewX(-5deg); display: none; }
        #combo-value { font-size: 3.5rem; font-weight: 900; color: var(--magenta); text-shadow: 0 0 20px var(--magenta); line-height: 1; font-style: italic; }
        #combo-label { font-size: 0.7rem; color: white; letter-spacing: 2px; margin-top: 5px; opacity: 0.8; }
        #game-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding: 20px; background: rgba(0,0,0,0.4); }
        .btn-game { font-size: 0.7rem; padding: 12px; color: #888; border-color: #333; }
        #progress-bar { width: 100%; height: 4px; background: #222; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: var(--cyan); transition: 0.3s; }
        .results-card { background: #121519; border: 1px solid var(--border); border-radius: 15px; padding: 30px; width: 100%; text-align: center; }
        .clout-total { font-size: 3rem; color: var(--yellow); font-weight: 900; margin: 10px 0; }
        .status-msg { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="console">
    <div id="screen-auth" class="screen">
        <div class="logo-small">BB XTRM</div>
        <h2>Musician Registry</h2>
        <input type="text" id="username" placeholder="ARTIST NAME">
        <button class="btn btn-primary" style="margin-top:20px" onclick="validateAuth()">LOGIN TO RIG</button>
    </div>

    <div id="screen-rules" class="screen">
        <div class="logo-small" style="color:var(--yellow); font-size:1.2rem;">OPERATIONAL PROTOCOL</div>
        <div class="rule-card"><h3>01. THE SET LIST</h3><p>Complete 10 tasks to finish a session and bank your clout.</p></div>
        <div class="rule-card" style="border-color: var(--magenta);"><h3>02. CLOUT & COMBOS</h3><p>Build streaks to multiply your Clout earnings.</p></div>
        <div class="rule-card" style="border-color: var(--yellow);"><h3>03. RISK MITIGATION</h3><p>Use Clout to Skip (-10) or Reroll (-5) the card and timer.</p></div>
        <button class="btn btn-primary" onclick="showScreen('screen-modes')">INITIATE RIG</button>
    </div>

    <div id="screen-modes" class="screen">
        <div class="logo-big">BB<br>XTRM</div>
        <h2 id="welcome-msg">SELECT WORKFLOW</h2>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--cyan)" onclick="startGame('production')">ENGINEER / MIX</button>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--green)" onclick="startGame('beats')">BEAT MAKER / SAMPLER</button>
        <button class="btn" style="margin-bottom:8px; border-left: 5px solid var(--magenta)" onclick="startGame('songwriting')">LYRICIST / WRITER</button>
        <button class="btn" style="margin-bottom:20px; border-left: 5px solid var(--yellow)" onclick="startGame('xtrm')">XTRM RANDOM</button>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn btn-game" style="flex:1" onclick="showLeaderboard()">RANKINGS</button>
            <button class="btn btn-game" style="flex:1" onclick="resetRig()">RESET RIG</button>
        </div>
    </div>

    <div id="screen-game" class="screen" style="padding:0; justify-content: flex-start;">
        <header style="width:100%; padding: 20px; display:flex; justify-content:space-between; font-size:0.75rem; border-bottom:1px solid var(--border); background: rgba(0,0,0,0.3);">
            <div id="user-tag" style="font-weight:bold; color:var(--cyan)">MUSICIAN: ---</div>
            <div id="task-counter" style="color:#666">SET: 1/10</div>
            <div id="clout-display" style="color:var(--yellow)">CLOUT: 0</div>
        </header>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="game-main" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; padding:25px;">
            <div id="timer">00:00</div>
            <div id="card">
                <div id="card-header" style="font-size:0.6rem; letter-spacing:4px; padding:10px; text-align:center; color:#444; border-bottom:1px solid #222;">SYSTEM_PROMPT</div>
                <div id="card-body-wrapper">
                    <div id="card-body">Awaiting sync...</div>
                    <div id="combo-container">
                        <div id="combo-value">x1.0</div>
                        <div id="combo-label">COMBO ACTIVE</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="game-controls">
            <button class="btn btn-primary" style="grid-column: span 2;" onclick="completeTask()">TASK COMPLETE</button>
            <button class="btn btn-game" onclick="skipCard()">SKIP (-10)</button>
            <button class="btn btn-game" onclick="rerollTimer()">REROLL (-5)</button>
            <button class="btn btn-game" onclick="togglePause()" id="pause-btn">PAUSE</button>
            <button class="btn btn-game" style="color:var(--red)" onclick="exitGame()">EJECT</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <div class="logo-small" id="result-header">SET COMPLETE!</div>
        <div class="results-card">
            <p id="result-artist" style="color:var(--cyan); font-weight:bold; margin-bottom:10px;">ARTIST: ---</p>
            <p class="status-msg">Clout Banked</p>
            <div class="clout-total" id="result-clout">0</div>
            <p class="status-msg" id="result-footer">The rig is cooling down.</p>
        </div>
        <button class="btn btn-primary" style="margin-top:30px" onclick="showScreen('screen-modes')">RETURN TO HUB</button>
    </div>

    <div id="screen-board" class="screen">
        <h2>Global Rankings</h2>
        <div style="width:100%; overflow-y: auto; max-height: 400px;">
            <table style="width:100%; margin-top:10px;"><tbody id="leaderboard-body"></tbody></table>
        </div>
        <button class="btn btn-primary" style="margin-top:40px" onclick="showScreen('screen-modes')">RETURN TO RIG</button>
    </div>
</div>

<script>
    // --- DATA ---
    const SET_LIMIT = 10;
    const paceDecks = [30, 45, 60, 90, 120];
    const cardDecks = {
        production: [
            'Turn down the loudest sound', 'Make the bass sound thicker', 'Add echo to the main melody', 'Make the drums sound like a big room', 'Remove low rumble from the piano',
            'Move a sound from left to right ear', 'Add a fuzzy sound to the kick drum', 'Make vocals sound like a phone call', 'Mute the loudest sound for 10 seconds', 'Make the quietest sound louder',
            'Add shimmer to high sounds', 'Make the song feel airy', 'Slowly turn up a new sound', 'Make drums sound sharp and punchy', 'Add a wah-wah effect',
            'Repeat a sound every 4 beats', 'Turn down high sounds on the bass', 'Make the snare drum snappier', 'Add a quiet ghost sound', 'Make the song sound moody',
            'Add a bright sound to the chorus', 'Make the main instrument sound wide', 'Add a robotic feel to a vocal', 'Make a sound pulse like a heart', 'Turn off all echo for a moment',
            'Make the kick drum feel like a thump', 'Add a swirling sound effect', 'Make the song sound underwater', 'Add a crackling record player sound', 'Make vocals sound very close',
            'Turn up middle sounds on a guitar', 'Make a sound stutter or glitch', 'Add a metallic ring to a sound', 'Make the song sound warm like tape', 'Add a hissing sound in the back',
            'Make the drums sound dry and close', 'Add a twinkling sound at the end', 'Make a sound fade away slowly', 'Turn the bass up very high', 'Make high-hats sound silky',
            'Add spacey reverb to a synth', 'Make the song sound aggressive', 'Add a pumping effect to the music', 'Make a sound vibrate quickly', 'Hide vocals behind the music',
            'Make the song sound lo-fi', 'Add a shaking sound to the beat', 'Make a sound feel heavy', 'Add a whistling sound', 'Make music dip when the kick hits',
            'Turn up treble on the bells', 'Make a sound feel hollow', 'Add a pulsing light sound', 'Make the song sound royal', 'Add a rain sound',
            'Make a sound jump between speakers', 'Add a clock ticking sound', 'Make the music feel fast', 'Add a laser sound effect', 'Make the song sound dusty',
            'Turn off the bass for one bar', 'Make the drums sound crushed', 'Add a hand clap', 'Make a sound sweep upwards', 'Add a robotic hum',
            'Make the song sound vintage', 'Add a dreamy texture', 'Make a sound bounce', 'Add a sharp edge to the lead', 'Make the song sound expensive',
            'Turn volume down on only the drums', 'Make a sound wobble', 'Add a clicking rhythm', 'Make the song feel empty', 'Add a distorted vocal',
            'Make a sound ring like a bell', 'Add an ocean wave sound', 'Make the song feel crowded', 'Add a glittery sound', 'Make a sound pop',
            'Turn up bass on the vocals', 'Make a sound slide up in pitch', 'Add a choppy effect', 'Make the song feel chilly', 'Add a fire crackle sound',
            'Make a sound growl', 'Add a magic chime', 'Make the song feel tough', 'Add a wind sound', 'Make the music stop suddenly'
        ],
        beats: [
            'Change the snare to a hand clap', 'Add one extra kick drum hit', 'Make hi-hats play twice as fast', 'Remove drums for 4 beats', 'Make the kick sound much deeper',
            'Add a shake sound every beat', 'Make the snare sound tinny', 'Play a drum fill at the end', 'Make hi-hats sound crunchy', 'Add a cowbell',
            'Make the drums swing like a dance', 'Add a tambourine', 'Make the kick drum slide down', 'Remove the snare for a bar', 'Add a rimshot sound',
            'Make the drums sound glitchy', 'Add a woodblock hit', 'Make hi-hats open and close', 'Add a bongo rhythm', 'Make drums sound like a cave',
            'Add a heavy stomp sound', 'Make the kick drum play a triplet', 'Add a snap instead of a snare', 'Move hi-hats left and right', 'Add a crash cymbal at the start',
            'Make drums sound old school', 'Add a shaker that never stops', 'Make the kick drum very short', 'Add a drum roll on the toms', 'Make drums sound industrial',
            'Add a human beatbox sound', 'Make hi-hats sound whispery', 'Add a reverse cymbal sound', 'Make the drums feel lazy and slow', 'Add a whistle on the beat',
            'Make the kick drum sound boxy', 'Add a triangle ding', 'Make the snare sound fat', 'Add a clink sound like glass', 'Make drums sound futuristic',
            'Add a conga drum loop', 'Make hi-hats very bright', 'Add a heartbeat kick pattern', 'Make the drums stop and start', 'Add a finger snap',
            'Make the snare sound wet with echo', 'Add a brush drum sound', 'Make the kick distorted', 'Add a sleigh bell rhythm', 'Make drums sound lo-fi',
            'Add a gong sound', 'Make hi-hats stutter', 'Add a knock sound', 'Make drums sound muffled', 'Add a clapper sound',
            'Make the kick drum double up', 'Add a chime on the first beat', 'Make the snare ring out', 'Add a scratchy record sound', 'Make drums jumpy',
            'Add a pop sound', 'Make hi-hats tick', 'Add a boom sound', 'Make drums smooth', 'Add a clicking beat',
            'Make the kick drum soft', 'Add a buzz sound', 'Make the snare sharp', 'Add a ticking clock drum', 'Make drums echo',
            'Add a rim click', 'Make hi-hats fizz', 'Add a thud sound', 'Make drums airy', 'Add a clap on every beat',
            'Make the kick punchy', 'Add a zip sound', 'Make the snare hollow', 'Add a shimmer drum', 'Make drums heavy',
            'Add a bell on the off-beat', 'Make hi-hats dark', 'Add a slap sound', 'Make drums clean', 'Add a jingle',
            'Make the kick fast', 'Add a pulse beat', 'Make the snare loose', 'Add a rattle', 'Make drums tight'
        ],
        songwriting: [
            'Write a line that rhymes with Blue', 'Do not use the word And for two lines', 'Write a line that is a question', 'Use a word starting with B', 'Write about a rainy day',
            'Use a fruit name in a line', 'Write a line about Time', 'Rhyme with the word Light', 'Write a line about walking', 'Use the word Secret',
            'Write a line about a friend', 'Rhyme with the word Play', 'Write a line about Home', 'Use the word Suddenly', 'Write a line about a dream',
            'Rhyme with the word Gold', 'Write a line about Fire', 'Use the word Wait', 'Write a line about music', 'Rhyme with the word Door',
            'Write a line about the moon', 'Use the word Believe', 'Write a line about flying', 'Rhyme with the word Heart', 'Write a line about water',
            'Use the word Forever', 'Write a line about changing', 'Rhyme with the word Star', 'Write a line about being lost', 'Use the word Found',
            'Write a line about a city', 'Rhyme with the word Street', 'Write a line about morning', 'Use the word Never', 'Write a line about shadows',
            'Rhyme with the word Sky', 'Write a line about colors', 'Use the word Memory', 'Write a line about bridges', 'Rhyme with the word Dance',
            'Write a line about winter', 'Use the word Strong', 'Write a line about flowers', 'Rhyme with the word Hand', 'Write a line about silence',
            'Use the word Listen', 'Write a line about a mountain', 'Rhyme with the word Tree', 'Write a line about gold', 'Use the word Silver',
            'Write a line about running', 'Rhyme with the word Cold', 'Write a line about summer', 'Use the word Hot', 'Write a line about dust',
            'Rhyme with the word Wind', 'Write a line about paper', 'Use the word Write', 'Write a line about glass', 'Rhyme with the word Stone',
            'Write a line about feathers', 'Use the word Soft', 'Write a line about iron', 'Rhyme with the word Break', 'Write a line about an echo',
            'Use the word Voice', 'Write a line about salt', 'Rhyme with the word Sea', 'Write a line about clouds', 'Use the word Rain',
            'Write a line about grass', 'Rhyme with the word Green', 'Write a line about the sun', 'Use the word Bright', 'Write a line about a road',
            'Rhyme with the word Miles', 'Write a line about sleep', 'Use the word Quiet', 'Write a line about a storm', 'Rhyme with the word Dark',
            'Write a line about light', 'Use the word Shadow', 'Write a line about kings', 'Rhyme with the word Ring', 'Write a line about wings',
            'Use the word High', 'Write a line about being deep', 'Rhyme with the word Deep', 'Write a line about being fast', 'Rhyme with the word Last'
        ]
    };

    // --- STATE ---
    let clout = 0, timeLeft = 0, timerInterval = null, isPaused = false, selectedMode = '', currentType = '', tasksCompleted = 0;
    let combo = 0, multiplier = 1.0, currentCallsign = "";
    let lastCardText = ""; // To prevent repeats
    const API_PATH = "/.netlify/functions";

    // --- CORE FUNCTIONS ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        const target = document.getElementById(id);
        if(target) target.classList.add('active-screen');
    }

    function validateAuth() {
        const name = document.getElementById('username').value.trim().toUpperCase();
        if (name.length < 2) return alert("IDENTIFICATION REQUIRED");
        currentCallsign = name;
        localStorage.setItem('bb_artist_name', name);
        showScreen('screen-rules');
    }

    function startGame(mode) {
        selectedMode = mode;
        tasksCompleted = 0;
        clout = 0;
        combo = 0;
        multiplier = 1.0;
        document.getElementById('user-tag').innerText = `MUSICIAN: ${currentCallsign}`;
        showScreen('screen-game');
        drawTask();
    }

    function drawTask() {
        if (tasksCompleted >= SET_LIMIT) { endSession(); return; }
        
        isPaused = false;
        document.getElementById('pause-btn').innerText = "PAUSE";
        
        // Pick random mode if XTRM
        currentType = selectedMode === 'xtrm' ? ['production', 'songwriting', 'beats'][Math.floor(Math.random() * 3)] : selectedMode;
        
        const deck = cardDecks[currentType];
        
        // Pick card and ensure it's not the same as the last one
        let newCard;
        do {
            newCard = deck[Math.floor(Math.random() * deck.length)];
        } while (newCard === lastCardText);
        
        lastCardText = newCard;
        document.getElementById('card-body').innerText = newCard;
        document.getElementById('card-body').style.color = { production: 'var(--cyan)', songwriting: 'var(--magenta)', beats: 'var(--green)' }[currentType];
        
        const seconds = paceDecks[Math.floor(Math.random() * paceDecks.length)];
        updateSessionUI();
        startTimer(seconds);
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        timeLeft = seconds;
        updateUI();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeLeft--; updateUI();
                if (timeLeft <= 0) breakCombo();
            }
        }, 1000);
    }

    function updateUI() {
        const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
        const el = document.getElementById('timer');
        el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        el.style.color = timeLeft < 10 ? 'var(--red)' : 'var(--yellow)';
        document.getElementById('clout-display').innerText = `CLOUT: ${clout}`;
        document.getElementById('combo-container').style.display = combo >= 3 ? 'block' : 'none';
        document.getElementById('combo-value').innerText = `x${multiplier.toFixed(1)}`;
    }

    function updateSessionUI() {
        document.getElementById('task-counter').innerText = `SET: ${tasksCompleted + 1}/${SET_LIMIT}`;
        document.getElementById('progress-fill').style.width = `${(tasksCompleted / SET_LIMIT) * 100}%`;
    }

    function completeTask() {
        tasksCompleted++;
        combo++;
        multiplier = 1.0 + Math.floor(combo / 3) * 0.5; 
        clout += Math.floor(10 * multiplier);
        drawTask();
    }

    function breakCombo() {
        clearInterval(timerInterval);
        combo = 0; multiplier = 1.0;
        document.getElementById('result-header').innerText = "SYSTEM FAILURE";
        document.getElementById('result-header').style.color = "var(--red)";
        document.getElementById('result-clout').innerText = "COMBO RESET";
        showScreen('screen-results');
    }

    // --- API SYNC FUNCTIONS ---
    async function endSession() {
        clearInterval(timerInterval);
        showScreen('screen-results');
        document.getElementById('result-artist').innerText = `ARTIST: ${currentCallsign}`;
        document.getElementById('result-clout').innerText = clout;
        document.getElementById('result-footer').innerText = "SYNCING TO GLOBAL RIG...";
        
        try {
            const res = await fetch(`${API_PATH}/save-score`, {
                method: 'POST',
                body: JSON.stringify({ username: currentCallsign, score: clout })
            });
            if(res.ok) document.getElementById('result-footer').innerText = "CLOUT BANKED SUCCESSFULLY.";
        } catch (e) { document.getElementById('result-footer').innerText = "LOCAL SAVE ONLY."; }
    }

    async function showLeaderboard() {
        const body = document.getElementById('leaderboard-body');
        body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px;">FETCHING SATELLITE...</td></tr>';
        showScreen('screen-board');
        try {
            const res = await fetch(`${API_PATH}/get-scores`);
            const data = await res.json();
            body.innerHTML = data.map((d, i) => `<tr><td style="padding:15px 0; border-bottom:1px solid #222;"><span style="color:var(--yellow)">#${i+1}</span> ${d.username}</td><td style="text-align:right; color:var(--yellow)">${d.clout}</td></tr>`).join('');
        } catch (e) { body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:20px; color:var(--red);">OFFLINE MODE</td></tr>'; }
    }

    // --- UTILS ---
    function skipCard() { if(clout >= 10) { clout -= 10; combo = 0; multiplier = 1.0; drawTask(); } }
    function rerollTimer() { if(clout >= 5) { clout -= 5; drawTask(); } }
    function togglePause() { isPaused = !isPaused; document.getElementById('pause-btn').innerText = isPaused ? "RESUME" : "PAUSE"; }
    function exitGame() { if(confirm("Eject?")) { clearInterval(timerInterval); showScreen('screen-modes'); } }
    function resetRig() { if(confirm("Wipe data?")) { localStorage.clear(); location.reload(); } }

    // --- INITIALIZE ---
    window.onload = () => {
        const saved = localStorage.getItem('bb_artist_name');
        if (saved) {
            currentCallsign = saved;
            document.getElementById('welcome-msg').innerText = `WELCOME, ${currentCallsign}`;
            showScreen('screen-modes');
        } else {
            showScreen('screen-auth');
        }
    };
</script>
</body>
</html>
